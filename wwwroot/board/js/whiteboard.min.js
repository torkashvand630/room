var whiteboard={permission:0,canvas:null,ctx:null,drawcolor:"black",tool:"pen",thickness:4,prevX:null,prevY:null,drawFlag:!1,oldGCO:null,mouseover:!1,lineCap:"round",backgroundGrid:null,canvasElement:null,cursorContainer:null,imgContainer:null,svgContainer:null,mouseOverlay:null,ownCursor:null,drawBuffer:[],num:1,wc:null,convasCount:board.pageCount+board.PdfPageCount,drawId:0,imgDragActive:!1,latestActiveTextBoxId:!1,pressedKeys:{},settings:{whiteboardId:"0",username:board.username,sendFunction:null,canvasWidth:1800,canvasHeight:1200,backgroundGridUrl:"/images/KtEBa2.png"},newConvas:function(n){var t="",i,r;n>board.pageCount&&(t="pdfElement");i=$('<canvas class="'+t+' myBoardItem" id="whiteboardCanvas'+n+'" style="position: absolute;  left:0px; top:0;  cursor:crosshair;display:none" height="'+board.height+'" width="'+board.width+'" ><\/canvas>');r=$('<div class="'+t+' myBoardItem" id="mtc'+n+'" class="textcontainer'+n+'" style="position: absolute; left:0px; top:0; height: 100%; width: 100%; cursor:text;;display:none;overflow: hidden;"><\/div>');$(this.wc).append(i);$(this.wc).append(r)},addFirstConvas:function(){for(var n=1;n<=this.convasCount;n++)n===1&&this.newConvas(n);document.getElementById("whiteboardCanvas1").style.display="block";this.activeConvas(1,0)},activeConvas:function(n){var t,i;n=1;t=document.getElementById("whiteboardCanvas"+n);t.style.display="block";this.canvas=t;i="http://www.w3.org/2000/svg";this.ctx=this.canvas.getContext("2d");this.oldGCO=this.ctx.globalCompositeOperation;this.num=n;console.log("activ chang : "+n);this.activeTextcontiner(n)},activeTextcontiner:function(n){var i=this,t;console.log("activ textcontiner : "+n);t=document.getElementById("mtc"+n);t.style.display="block";this.textContainer=$(t);this.textContainer.on("mousemove touchmove",function(n){if(n.preventDefault(),!this.imgDragActive&&$(n.target).hasClass("textcontainer")){var t=n.offsetX||n.pageX-$(n.target).offset().left,i=n.offsetY||n.pageY-$(n.target).offset().top;this.sendFunction({t:"cursor",event:"move",d:[t,i],username:this.settings.username})}});this.textContainer.on("click",function(n){currX=n.offsetX||n.pageX-$(n.target).offset().left;currY=n.offsetY||n.pageY-$(n.target).offset().top;var t=whiteboard.thickness,r="tx"+ +new Date;i.sendFunction({t:"addTextBox",d:[this.drawcolor,t,currX,currY,r]});i.addTextBox(this.drawcolor,t,currX,currY,r,!0)})},loadWhiteboard:function(n,t){var i=this;for(var r in t)this.settings[r]=t[r];this.settings.username=this.settings.username.replace(/[^0-9a-z]/gi,"");this.settings.whiteboardId=this.settings.whiteboardId.replace(/[^0-9a-z]/gi,"");this.wc=n;i.backgroundGrid=$('<div id="whiteboardBG" style="position: absolute; left:0px; top:0; opacity: 0.9;background-color: #e8e8eb; height: 100%; width: 100%;background-position: center;background-size: contain, cover;background-repeat: no-repeat;"><\/div>');i.imgContainer=$('<div style="position: absolute; left:0px; top:0; height: 100%; width: 100%;"><\/div>');i.svgContainer=$('<svg id="svgBoard" style="position: absolute; top:0px; left:0px;" width="'+board.width+'" height="'+board.height+'"><\/svg>');i.dropIndicator=$('<div style="position:absolute; height: 100%; width: 100%; border: 7px dashed gray; text-align: center; top: 0px; left: 0px; color: gray; font-size: 23em; display: none;"><i class="far fa-plus-square" aria-hidden="true"><\/i><\/div>');i.cursorContainer=$('<div style="position: absolute; left:0px; top:0; height: 100%; width: 100%;"><\/div>');i.mouseOverlay=$('<div style="cursor:none; position: absolute; left:0px; top:0; height: 100%; width: 100%;"><\/div>');$(n).append(i.backgroundGrid).append(i.imgContainer).append(i.svgContainer).append(i.dropIndicator).append(i.cursorContainer).append(i.mouseOverlay);this.addFirstConvas()},ffff:function(){function i(n,t){var i=n-startCoords[0],r=t-startCoords[1],u=Math.atan2(i,r)*(180/Math.PI),f=Math.round(u/45)*45;return f%90==0?Math.abs(n-startCoords[0])>Math.abs(t-startCoords[1])?t=startCoords[1]:n=startCoords[0]:n=(t-startCoords[1])*(n-startCoords[0])>0?startCoords[0]+(t-startCoords[1]):startCoords[0]-(t-startCoords[1]),{x:n,y:t}}var t="http://www.w3.org/2000/svg",n=this;$(n.mouseOverlay).on("mousedown touchstart",function(i){var r,u;whiteboard.permission&&(n.imgDragActive||(n.drawFlag=!0,n.prevX=i.offsetX||i.pageX-$(i.target).offset().left,n.prevY=i.offsetY||i.pageY-$(i.target).offset().top,n.prevX&&n.prevY||(r=i.touches[0],n.prevX=r.clientX-$(n.mouseOverlay).offset().left,n.prevY=r.clientY-$(n.mouseOverlay).offset().top,u=1/board.zoom,n.prevX=n.prevX*u,n.prevY=n.prevY*u,latestTouchCoods=[n.prevX,n.prevY]),n.tool==="pen"?(n.drawPenLine(n.prevX,n.prevY,n.prevX,n.prevY,n.drawcolor,n.thickness),n.sendFunction({t:n.tool,d:[n.prevX,n.prevY,n.prevX,n.prevY],c:n.drawcolor,th:n.thickness})):n.tool==="eraser"?(n.drawEraserLine(n.prevX,n.prevY,n.prevX,n.prevY,n.thickness),n.sendFunction({t:n.tool,d:[n.prevX,n.prevY,n.prevX,n.prevY],th:n.thickness})):n.tool==="line"?(startCoords=[n.prevX,n.prevY],svgLine=document.createElementNS(t,"line"),svgLine.setAttribute("stroke","gray"),svgLine.setAttribute("stroke-dasharray","5, 5"),svgLine.setAttribute("x1",n.prevX),svgLine.setAttribute("y1",n.prevY),svgLine.setAttribute("x2",n.prevX+1),svgLine.setAttribute("y2",n.prevY+1),n.svgContainer.append(svgLine)):n.tool==="rect"||n.tool==="recSelect"?(n.svgContainer.find("rect").remove(),svgRect=document.createElementNS(t,"rect"),svgRect.setAttribute("stroke","gray"),svgRect.setAttribute("stroke-dasharray","5, 5"),svgRect.setAttribute("style","fill-opacity:0.0;"),svgRect.setAttribute("x",n.prevX),svgRect.setAttribute("y",n.prevY),svgRect.setAttribute("width",0),svgRect.setAttribute("height",0),n.svgContainer.append(svgRect),startCoords=[n.prevX,n.prevY]):n.tool==="circle"&&(svgCirle=document.createElementNS(t,"circle"),svgCirle.setAttribute("stroke","gray"),svgCirle.setAttribute("stroke-dasharray","5, 5"),svgCirle.setAttribute("style","fill-opacity:0.0;"),svgCirle.setAttribute("cx",n.prevX),svgCirle.setAttribute("cy",n.prevY),svgCirle.setAttribute("r",0),n.svgContainer.append(svgCirle),startCoords=[n.prevX,n.prevY])))});n.mouseOverlay.on("mousemove touchmove",function(t){if(whiteboard.permission&&(t.preventDefault(),!n.imgDragActive)){var r=t.offsetX||t.pageX-$(t.target).offset().left,u=t.offsetY||t.pageY-$(t.target).offset().top;window.requestAnimationFrame(function(){var c,l,e,o,a,f,v,s,h;if((!r||!u)&&t.touches&&t.touches[0]&&(c=t.touches[0],r=c.clientX-$(n.mouseOverlay).offset().left,u=c.clientY-$(n.mouseOverlay).offset().top,l=1/board.zoom,r=r*l,u=u*l,latestTouchCoods=[r,u]),n.drawFlag&&(n.tool==="pen"?(n.drawPenLine(r,u,n.prevX,n.prevY,n.drawcolor,n.thickness),n.sendFunction({t:n.tool,d:[r,u,n.prevX,n.prevY],c:n.drawcolor,th:n.thickness})):n.tool=="eraser"&&(n.drawEraserLine(r,u,n.prevX,n.prevY,n.thickness),n.sendFunction({t:n.tool,d:[r,u,n.prevX,n.prevY],th:n.thickness})),n.prevX=r,n.prevY=u),n.tool==="eraser")e=r-n.thickness,o=u-n.thickness,n.ownCursor.css({top:o+"px",left:e+"px"});else if(n.tool==="pen")e=r-n.thickness,o=u-n.thickness,n.ownCursor.css({top:o+"px",left:e+"px"});else if(n.tool==="line")svgLine&&(n.pressedKeys.shift&&(a=i(r,u),r=a.x,u=a.y),svgLine.setAttribute("x2",r),svgLine.setAttribute("y2",u));else if(n.tool==="rect"||n.tool==="recSelect"&&n.drawFlag)svgRect&&(f=Math.abs(r-startCoords[0]),v=Math.abs(u-startCoords[1]),n.pressedKeys.shift?(v=f,s=r<startCoords[0]?startCoords[0]-f:startCoords[0],h=u<startCoords[1]?startCoords[1]-f:startCoords[1],svgRect.setAttribute("x",s),svgRect.setAttribute("y",h)):(s=r<startCoords[0]?r:startCoords[0],h=u<startCoords[1]?u:startCoords[1],svgRect.setAttribute("x",s),svgRect.setAttribute("y",h)),svgRect.setAttribute("width",f),svgRect.setAttribute("height",v));else if(n.tool==="circle"){var y=r-startCoords[0],p=u-startCoords[1],w=Math.sqrt(y*y+p*p);svgCirle&&svgCirle.setAttribute("r",w)}});n.sendFunction({t:"cursor",event:"move",d:[r,u],username:n.settings.username})}});n.mouseOverlay.on("mouseup touchend touchcancel",function(t){var r,u,c,p;if(whiteboard.permission&&!n.imgDragActive)if(n.drawFlag=!1,n.drawId++,n.ctx.globalCompositeOperation=n.oldGCO,r=t.offsetX||t.pageX-$(t.target).offset().left,u=t.offsetY||t.pageY-$(t.target).offset().top,r&&u||!t.touches[0]||(r=latestTouchCoods[0],u=latestTouchCoods[1],n.sendFunction({t:"cursor",event:"out",username:n.settings.username})),n.tool==="line")n.pressedKeys.shift&&(c=i(r,u),r=c.x,u=c.y),n.drawPenLine(r,u,startCoords[0],startCoords[1],n.drawcolor,n.thickness),n.sendFunction({t:n.tool,d:[r,u,startCoords[0],startCoords[1]],c:n.drawcolor,th:n.thickness}),n.svgContainer.find("line").remove();else if(n.tool==="rect")n.pressedKeys.shift&&(u=(u-startCoords[1])*(r-startCoords[0])>0?startCoords[1]+(r-startCoords[0]):startCoords[1]-(r-startCoords[0])),n.drawRec(startCoords[0],startCoords[1],r,u,n.drawcolor,n.thickness),n.sendFunction({t:n.tool,d:[startCoords[0],startCoords[1],r,u],c:n.drawcolor,th:n.thickness}),n.svgContainer.find("rect").remove();else if(n.tool==="circle"){var a=r-startCoords[0],v=u-startCoords[1],y=Math.sqrt(a*a+v*v);n.drawCircle(startCoords[0],startCoords[1],y,n.drawcolor,n.thickness);n.sendFunction({t:n.tool,d:[startCoords[0],startCoords[1],y],c:n.drawcolor,th:n.thickness});n.svgContainer.find("circle").remove()}else if(n.tool==="recSelect"){n.imgDragActive=!0;n.pressedKeys.shift&&(u=(u-startCoords[1])*(r-startCoords[0])>0?startCoords[1]+(r-startCoords[0]):startCoords[1]-(r-startCoords[0]));var e=Math.abs(startCoords[0]-r),o=Math.abs(startCoords[1]-u),s=startCoords[0]<r?startCoords[0]:r,h=startCoords[1]<u?startCoords[1]:u;n.mouseOverlay.css({cursor:"default"});var f=$('<div style="position:absolute; left:'+s+"px; top:"+h+"px; width:"+e+"px; border: 2px dotted gray; overflow: hidden; height:"+o+'px;" cursor:move;"><canvas style="cursor:move; position:absolute; top:0px; left:0px;" width="'+e+'" height="'+o+'"/><div style="position:absolute; right:5px; top:3px;"><button draw="1" style="margin: 0px 0px; background: #03a9f4; padding: 5px; margin-top: 3px; color: white;" class="addToCanvasBtn btn btn-default">Drop<\/button> <button style="margin: 0px 0px; background: #03a9f4; padding: 5px; margin-top: 3px; color: white;" class="xCanvasBtn btn btn-default">x<\/button><\/div><\/div>'),w=$(f).find("canvas"),l=$('<div class="dragOutOverlay" style="position:absolute; left:'+s+"px; top:"+h+"px; width:"+e+"px; height:"+o+'px; background:white;"><\/div>');n.mouseOverlay.append(l);n.mouseOverlay.append(f);p=w[0].getContext("2d");p.drawImage(n.canvas,s,h,e,o,0,0,e,o);f.find(".xCanvasBtn").click(function(){n.imgDragActive=!1;n.refreshCursorAppearance();f.remove();l.remove()});f.find(".addToCanvasBtn").click(function(){n.imgDragActive=!1;n.refreshCursorAppearance();var t=f.position(),i=Math.round(t.left*100)/100,r=Math.round(t.top*100)/100;n.drawId++;n.sendFunction({t:n.tool,d:[s,h,i,r,e,o]});n.dragCanvasRectContent(s,h,i,r,e,o);f.remove();l.remove()});f.draggable();n.svgContainer.find("rect").remove()}});n.mouseOverlay.on("mouseout",function(){whiteboard.permission&&(n.imgDragActive||(n.drawFlag=!1,n.mouseover=!1,n.ctx.globalCompositeOperation=n.oldGCO,n.ownCursor.remove(),n.svgContainer.find("line").remove(),n.svgContainer.find("rect").remove(),n.svgContainer.find("circle").remove(),n.sendFunction({t:"cursor",event:"out"})))});n.mouseOverlay.on("mouseover",function(){if(whiteboard.permission&&!n.imgDragActive){if(!n.mouseover){var i=n.drawcolor,t=n.thickness;n.tool==="eraser"&&(i="#00000000",t=t*2);(n.tool==="eraser"||n.tool==="pen")&&(n.ownCursor=$('<div id="ownCursor" style="background:'+i+"; border:1px solid gray; position:absolute; width:"+t+"px; height:"+t+'px; border-radius:50%;"><\/div>'),n.cursorContainer.append(n.ownCursor))}n.mouseover=!0}})},addConvas:function(n){var t,i;document.getElementById("whiteboardCanvas"+this.num).style.display="none";this.num++;console.log("ddddddd :"+this.num);t=$('<canvas id="whiteboardCanvas'+this.num+'" style="position: absolute; left:0px; top:0; cursor:crosshair;"><\/canvas>');$(n).append(t);i="http://www.w3.org/2000/svg";this.canvas=$("#whiteboardCanvas"+this.num)[0];this.canvas.height=board.height;this.canvas.width=board.width;this.ctx=this.canvas.getContext("2d");this.oldGCO=this.ctx.globalCompositeOperation},preConvas:function(){document.getElementById("whiteboardCanvas"+this.num).style.display="none";this.num--;console.log("ddddddd :"+this.num);document.getElementById("whiteboardCanvas"+this.num).style.display="block";this.canvas=$("#whiteboardCanvas"+this.num)[0];this.ctx=this.canvas.getContext("2d")},nextConvas:function(){if(!(this.num>=2)){document.getElementById("whiteboardCanvas"+this.num).style.display="none";this.num++;console.log("nnn :"+this.num);document.getElementById("whiteboardCanvas"+this.num).style.display="block";this.canvas=$("#whiteboardCanvas"+this.num)[0];this.canvas.height=board.height;this.canvas.width=board.width;this.ctx=this.canvas.getContext("2d");this.oldGCO=this.ctx.globalCompositeOperation}},entfKeyAction:function(){var n=this;$.each(n.mouseOverlay.find(".dragOutOverlay"),function(){var t=$(this).width(),i=$(this).height(),r=$(this).position(),u=Math.round(r.left*100)/100,f=Math.round(r.top*100)/100;n.drawId++;n.sendFunction({t:"eraseRec",d:[u,f,t,i]});n.eraseRec(u,f,t,i)});n.mouseOverlay.find(".xCanvasBtn").click()},escKeyAction:function(){var n=this;n.drawFlag||n.svgContainer.empty();n.mouseOverlay.find(".xCanvasBtn").click()},dragCanvasRectContent:function(n,t,i,r,u,f){var e=document.createElement("canvas"),o;e.width=u;e.height=f;o=e.getContext("2d");o.drawImage(this.canvas,n,t,u,f,0,0,u,f);this.eraseRec(n,t,u,f);this.ctx.drawImage(e,i,r)},eraseRec:function(n,t,i,r){var u=this;u.ctx.beginPath();u.ctx.rect(n,t,i,r);u.ctx.fillStyle="rgba(0,0,0,1)";u.ctx.globalCompositeOperation="destination-out";u.ctx.fill();u.ctx.closePath();u.ctx.globalCompositeOperation=u.oldGCO},drawPenLine:function(n,t,i,r,u,f){var e=this;e.ctx.beginPath();e.ctx.moveTo(n,t);e.ctx.lineTo(i,r);e.ctx.strokeStyle=u;e.ctx.lineWidth=f;e.ctx.lineCap=e.lineCap;e.ctx.stroke();e.ctx.closePath()},drawEraserLine:function(n,t,i,r,u){var f=this;f.ctx.beginPath();f.ctx.moveTo(n,t);f.ctx.lineTo(i,r);f.ctx.strokeStyle="rgba(0,0,0,1)";f.ctx.lineWidth=u*2;f.ctx.lineCap=f.lineCap;f.ctx.globalCompositeOperation="destination-out";f.ctx.stroke();f.ctx.closePath();f.ctx.globalCompositeOperation=f.oldGCO},drawRec:function(n,t,i,r,u,f){var e=this;i=i-n;r=r-t;e.ctx.beginPath();e.ctx.rect(n,t,i,r);e.ctx.strokeStyle=u;e.ctx.lineWidth=f;e.ctx.lineCap=e.lineCap;e.ctx.stroke();e.ctx.closePath()},drawCircle:function(n,t,i,r,u){var f=this;f.ctx.beginPath();f.ctx.arc(n,t,i,0,2*Math.PI,!1);f.ctx.lineWidth=u;f.ctx.strokeStyle=r;f.ctx.stroke()},clearWhiteboard:function(){var n=this;n.canvas.height=n.canvas.height;n.imgContainer.empty();n.textContainer.empty();n.sendFunction({t:"clear"});n.drawBuffer=[];n.drawId=0},setStrokeThickness:function(n){var t=this;t.thickness=n;t.tool=="text"&&t.latestActiveTextBoxId&&(t.sendFunction({t:"setTextboxFontSize",d:[t.latestActiveTextBoxId,n]}),t.setTextboxFontSize(t.latestActiveTextBoxId,n))},addImgToCanvasByUrl:function(n){var t=this,r=!1,i;t.tool==="text"&&(r=!0,t.setTool("mouse"));t.imgDragActive=!0;t.mouseOverlay.css({cursor:"default"});i=$('<div style="border: 2px dashed gray; position:absolute; left:200px; top:200px; min-width:160px; min-height:100px; cursor:move;"><img style="width:100%; height:100%;" src="'+n+'"><div style="position:absolute; right:5px; top:3px;"><button draw="1" style="margin: 0px 0px; background: #03a9f4; padding: 5px; margin-top: 3px; color: white;" class="addToCanvasBtn btn btn-default">Draw to canvas<\/button> <button draw="0" style="margin: 0px 0px; background: #03a9f4; padding: 5px; margin-top: 3px; color: white;" class="addToCanvasBtn btn btn-default">Add to background<\/button> <button style="margin: 0px 0px; background: #03a9f4; padding: 5px; margin-top: 3px; color: white;" class="xCanvasBtn btn btn-default">x<\/button><\/div><i style="position:absolute; bottom: -4px; right: 2px; font-size: 2em; color: gray; transform: rotate(-45deg);" class="fas fa-sort-down" aria-hidden="true"><\/i><\/div>');i.find(".xCanvasBtn").click(function(){t.imgDragActive=!1;t.refreshCursorAppearance();i.remove();r&&t.setTool("text")});i.find(".addToCanvasBtn").click(function(){var s=$(this).attr("draw");t.imgDragActive=!1;t.refreshCursorAppearance();var u=i.width(),f=i.height(),h=i.position(),e=Math.round(h.left*100)/100,o=Math.round(h.top*100)/100;s=="1"?t.drawImgToCanvas(n,u,f,e,o):t.drawImgToBackground(n,u,f,e,o);t.sendFunction({t:"addImgBG",draw:s,url:n,d:[u,f,e,o]});t.drawId++;i.remove();r&&t.setTool("text")});t.mouseOverlay.append(i);i.draggable();i.resizable()},drawImgToBackground:function(n,t,i,r,u){this.imgContainer.append('<img crossorigin="anonymous" style="width:'+t+"px; height:"+i+"px; position:absolute; top:"+u+"px; left:"+r+'px;" src="'+n+'">')},addTextBox:function(n,t,i,r,u,f){var o=this,e=$('<div id="'+u+'" class="textBox" style="font-family: monospace; position:absolute; top:'+r+"px; left:"+i+'px;"><div contentEditable="true" spellcheck="false" class="textContent" style="outline: none; font-size:'+t+"em; color:"+n+'; min-width:50px; min-height:50px;"><\/div><div title="remove textbox" class="removeIcon" style="position:absolute; cursor:pointer; top:-4px; right:2px;">x<\/div><div title="move textbox" class="moveIcon" style="position:absolute; cursor:move; top:1px; left:2px; font-size: 0.5em;"><i class="fas fa-expand-arrows-alt"><\/i><\/div><\/div>');o.latestActiveTextBoxId=u;e.click(function(n){return n.preventDefault(),o.latestActiveTextBoxId=u,!1});e.on("mousemove touchmove",function(n){if(n.preventDefault(),!o.imgDragActive){var t=e.position(),i=n.offsetX+t.left,r=n.offsetY+t.top;$(n.target).hasClass("removeIcon")&&(i+=e.width()-4);o.sendFunction({t:"cursor",event:"move",d:[i,r],username:o.settings.username})}});this.textContainer.append(e);e.draggable({handle:".moveIcon",stop:function(){var n=e.position();o.sendFunction({t:"setTextboxPosition",d:[u,n.top,n.left]})},drag:function(){var n=e.position();o.sendFunction({t:"setTextboxPosition",d:[u,n.top,n.left]})}});e.find(".textContent").on("input",function(){var n=$(this).html();o.sendFunction({t:"setTextboxText",d:[u,n]})});e.find(".removeIcon").click(function(n){return $("#"+u).remove(),o.sendFunction({t:"removeTextbox",d:[u]}),n.preventDefault(),!1});f&&e.find(".textContent").focus();this.tool==="text"&&e.addClass("active")},setTextboxText:function(n,t){$("#"+n).find(".textContent").html(t)},removeTextbox:function(n){$("#"+n).remove()},setTextboxPosition:function(n,t,i){$("#"+n).css({top:t+"px",left:i+"px"})},setTextboxFontSize:function(n,t){$("#"+n).find(".textContent").css({"font-size":t+"em"})},setTextboxFontColor:function(n,t){$("#"+n).find(".textContent").css({color:t})},drawImgToCanvas:function(n,t,i,r,u,f){var o=this,e=document.createElement("img");e.onload=function(){o.ctx.drawImage(e,r,u,t,i);f&&f()};e.src=n},undoWhiteboard:function(n){var t=this,r,i;for(n||(n=t.settings.username),i=t.drawBuffer.length-1;i>=0;i--)if(t.drawBuffer[i].username==n){for(r=t.drawBuffer[i].drawId,i=t.drawBuffer.length-1;i>=0;i--)t.drawBuffer[i].drawId==r&&t.drawBuffer[i].username==n&&t.drawBuffer.splice(i,1);break}t.canvas.height=t.canvas.height;t.imgContainer.empty();t.loadDataInSteps(t.drawBuffer,!1,function(){})},undoWhiteboardClick:function(){this.sendFunction({t:"undo"});this.undoWhiteboard()},setTool:function(n){this.tool=n;this.tool==="text"?($(".textBox").addClass("active"),this.textContainer.appendTo($(whiteboardContainer))):($(".textBox").removeClass("active"),this.mouseOverlay.appendTo($(whiteboardContainer)));this.refreshCursorAppearance();this.mouseOverlay.find(".xCanvasBtn").click();this.latestActiveTextBoxId=null},setDrawColor:function(n){var t=this;t.drawcolor=n;t.tool=="text"&&t.latestActiveTextBoxId&&(t.sendFunction({t:"setTextboxFontColor",d:[t.latestActiveTextBoxId,n]}),t.setTextboxFontColor(t.latestActiveTextBoxId,n))},updateSmallestScreenResolution:function(n,t){this.backgroundGrid.empty();(n<$(window).width()||t<$(window).height())&&(this.backgroundGrid.append('<div style="position:absolute; left:0px; top:0px; border-right:3px dotted black; border-bottom:3px dotted black; width:'+n+"px; height:"+t+'px;"><\/div>'),this.backgroundGrid.append('<div style="position:absolute; left:'+(n+5)+'px; top:0px;">smallest screen participating<\/div>'))},handleEventsAndData:function(n,t,i){var u=this,f=n.t,o=n.num,e;if(o=Number(o),e=n.fileID,e=Number(e),(e!=bboard.fileID||o!=bboard.pageID)&&bboard.activePage(e,o),f=="setImage"){fileService.setImageParse(n);return}var r=n.d,h=n.c,c=n.username,s=n.th;f==="line"||f==="pen"?u.drawPenLine(r[0],r[1],r[2],r[3],h,s):f==="rect"?u.drawRec(r[0],r[1],r[2],r[3],h,s):f==="circle"?u.drawCircle(r[0],r[1],r[2],h,s):f==="eraser"?u.drawEraserLine(r[0],r[1],r[2],r[3],s):f==="eraseRec"?u.eraseRec(r[0],r[1],r[2],r[3]):f==="recSelect"?u.dragCanvasRectContent(r[0],r[1],r[2],r[3],r[4],r[5]):f==="addImgBG"?n.draw=="1"?u.drawImgToCanvas(n.url,r[0],r[1],r[2],r[3],i):u.drawImgToBackground(n.url,r[0],r[1],r[2],r[3]):f==="addTextBox"?u.addTextBox(r[0],r[1],r[2],r[3],r[4]):f==="setTextboxText"?u.setTextboxText(r[0],r[1]):f==="removeTextbox"?u.removeTextbox(r[0]):f==="setTextboxPosition"?u.setTextboxPosition(r[0],r[1],r[2]):f==="setTextboxFontSize"?u.setTextboxFontSize(r[0],r[1]):f==="setTextboxFontColor"?u.setTextboxFontColor(r[0],r[1]):f==="clear"?(u.canvas.height=u.canvas.height,u.imgContainer.empty(),u.textContainer.empty(),u.drawBuffer=[],u.drawId=0):f==="cursor"&&u.settings?n.event==="move"?u.cursorContainer.find("."+n.username).length>=1?u.cursorContainer.find("."+n.username).css({left:r[0]+"px",top:r[1]-15+"px"}):u.cursorContainer.append('<div style="font-size:0.8em; padding-left:2px; padding-right:2px; background:gray; color:white; border-radius:3px; position:absolute; left:'+r[0]+"px; top:"+(r[1]-151)+'px;" class="userbadge '+n.username+'"><div style="width:4px; height:4px; background:gray; position:absolute; top:13px; left:-2px; border-radius:50%;"><\/div>'+n.username+"<\/div>"):u.cursorContainer.find("."+n.username).remove():f==="undo"&&u.undoWhiteboard(c);t&&["line","pen","rect","circle","eraser","addImgBG","recSelect","eraseRec","addTextBox","setTextboxText","removeTextbox","setTextboxPosition","setTextboxFontSize","setTextboxFontColor"].includes(f)&&(n.drawId=n.drawId?n.drawId:u.drawId,n.username=n.username?n.username:u.settings.username)},userLeftWhiteboard:function(n){this.cursorContainer.find("."+n).remove()},refreshUserBadges:function(){this.cursorContainer.find(".userbadge").remove()},getImageDataBase64:function(){var t,i;_this=this;var r=this.mouseOverlay.width(),u=this.mouseOverlay.height(),n=document.createElement("canvas");return n.width=r,n.height=u,t=n.getContext("2d"),$.each(_this.imgContainer.find("img"),function(){var i=$(this).width(),r=$(this).height(),n=$(this).position(),u=Math.round(n.left*100)/100,f=Math.round(n.top*100)/100;t.drawImage(this,u,f,i,r)}),i=n.getContext("2d"),i.drawImage(this.canvas,0,0),$.each($(".textBox"),function(){var u=$(this),n=$(this).find(".textContent"),f=n.text(),e=n.css("font-size"),o=n.css("color"),i=u.position(),s=Math.round(i.left*100)/100,r=Math.round(i.top*100)/100;r+=25;t.font=e+" monospace";t.fillStyle=o;t.fillText(f,s,r)}),n.toDataURL()},getImageDataJson:function(){for(var t=[],n=0;n<this.drawBuffer.length;n++)t.push(JSON.parse(JSON.stringify(this.drawBuffer[n]))),delete t[n].username,delete t[n].wid,delete t[n].drawId;return JSON.stringify(t)},loadData:function(n){var t=this;t.loadDataInSteps(n,!0,function(n){n.username==t.settings.username&&t.drawId<n.drawId&&(t.drawId=n.drawId+1)})},loadDataInSteps:function(n,t,i){function u(f){for(var e=f;e<n.length;e++)if(n[e].t==="addImgBG"&&n[e].draw=="1"){r.handleEventsAndData(n[e],t,function(){i(n[e],e);u(e+1)});break}else r.handleEventsAndData(n[e],t),i(n[e],e)}var r=this;u(0)},loadJsonData:function(n,t){var i=this;i.loadDataInSteps(n,!1,function(r,u){i.sendFunction(r);u>=n.length-1&&(i.drawId++,t&&t())})},sendFunction:function(n){var t=this,i,r;(n.wid=t.settings.whiteboardId,n.username=t.settings.username,n.drawId=t.drawId,i=n.event,i!="move")&&(r=n.t,t.settings.sendFunction&&t.settings.sendFunction(n),["line","pen","rect","circle","eraser","addImgBG","recSelect","eraseRec","addTextBox","setTextboxText","removeTextbox","setTextboxPosition","setTextboxFontSize","setTextboxFontColor"].includes(r)&&t.drawBuffer.push(n))},refreshCursorAppearance:function(){var n=this;n.tool==="pen"||n.tool==="eraser"?n.mouseOverlay.css({cursor:"none"}):n.tool==="mouse"?this.mouseOverlay.css({cursor:"default"}):n.mouseOverlay.css({cursor:"crosshair"})}};