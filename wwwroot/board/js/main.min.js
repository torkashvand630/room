function uploadImgAndAddToWhiteboard(n){var t=+new Date;$.ajax({type:"POST",url:document.URL.substr(0,document.URL.lastIndexOf("/"))+"/upload",data:{imagedata:n,whiteboardId:whiteboardId,date:t,at:accessToken},success:function(){var n=whiteboardId+"_"+t+".png";whiteboard.addImgToCanvasByUrl(document.URL.substr(0,document.URL.lastIndexOf("/"))+"/uploads/"+n);console.log("Image uploaded!")},error:function(n){showBasicAlert("Failed to upload frame: "+JSON.stringify(n))}})}function saveWhiteboardToWebdav(n,t,i){var r=+new Date;$.ajax({type:"POST",url:document.URL.substr(0,document.URL.lastIndexOf("/"))+"/upload",data:{imagedata:n,whiteboardId:whiteboardId,date:r,at:accessToken,webdavaccess:JSON.stringify(t)},success:function(){showBasicAlert("Whiteboard was saved to Webdav!",{headercolor:"#5c9e5c"});console.log("Image uploaded for webdav!");i()},error:function(n){n.status==403?showBasicAlert("Could not connect to Webdav folder! Please check the credentials and paths and try again!"):showBasicAlert("Unknown Webdav error! ",n);i(n)}})}function isImageFileName(n){var t=n.split(".")[n.split(".").length-1];return["png","jpg","jpeg","gif","tiff","bmp","webp"].includes(t.toLowerCase())}function isValidImageUrl(n,t){var i=new Image,r=null;i.onerror=i.onabort=function(){clearTimeout(r);t(!1)};i.onload=function(){clearTimeout(r);t(!0)};r=setTimeout(function(){t(!1)},2e3);i.src=n}function showBasicAlert(n,t){var r={header:"INFO MESSAGE",okBtnText:"Ok",headercolor:"#d25d5d"},u,i;if(t)for(u in t)r[u]=t[u];i=$('<div class="basicalert" style="position:absolute; top:0px; left:0px; width:100%; top:70px; font-family: monospace;"><div style="width: 30%; margin: auto; background: #aaaaaa; border-radius: 5px; font-size: 1.2em; border: 1px solid gray;"><div style="border-bottom: 1px solid #676767; background: '+r.headercolor+'; padding-left: 5px; font-size: 0.8em;">'+r.header+'<\/div><div style="padding: 10px;" class="htmlcontent"><\/div><div style="height: 20px; padding: 10px;"><button class="modalBtn okbtn" style="float: right;">'+r.okBtnText+"<\/button><\/div><\/div><\/div>");i.find(".htmlcontent").append(n);$("body").append(i);i.find(".okbtn").click(function(){i.remove()})}function getQueryVariable(n){for(var i,u=window.location.search.substring(1),r=u.split("&"),t=0;t<r.length;t++)if(i=r[t].split("="),i[0]==n)return i[1];return!1}var whiteboardId=board.meetID,myUsername=board.userName,accessToken="11",accessDenied,i;myUsername=myUsername||"unknown"+(Math.random()+"").substring(2,6);accessToken=accessToken||"";accessDenied=!1;console.warn("meet : "+whiteboardId+" userName= "+myUsername);var url=document.URL.substr(0,document.URL.lastIndexOf("/")),signaling_socket=null,urlSplit=url.split("/"),subdir="";for(i=3;i<urlSplit.length;i++)subdir=subdir+"/"+urlSplit[i];subdir=board.host;console.warn(subdir);$(document).ready(function(){var t,n;$(window).resize(function(){});$(document).on("keydown",function(n){n.which==17?whiteboard.pressedKeys.strg=!0:n.which==90?(whiteboard.pressedKeys.strg&&!whiteboard.pressedKeys.z&&whiteboard.undoWhiteboardClick(),whiteboard.pressedKeys.z=!0):n.which==16?whiteboard.pressedKeys.shift=!0:n.which==27?whiteboard.escKeyAction():n.which==46&&whiteboard.entfKeyAction()});$(document).on("keyup",function(n){n.which==17?whiteboard.pressedKeys.strg=!1:n.which==90?whiteboard.pressedKeys.z=!1:n.which==16&&(whiteboard.pressedKeys.shift=!1)});$("#whiteboardTrashBtn").click(function(){$("#whiteboardTrashBtnConfirm").show().focus()});$("#whiteboardTrashBtnConfirm").focusout(function(){$(this).hide()});$("#whiteboardTrashBtnConfirm").click(function(){$(this).hide();whiteboard.clearWhiteboard()});$("#whiteboardUndoBtn").click(function(){whiteboard.undoWhiteboardClick()});$(".whiteboardTool").click(function(){$(".whiteboardTool").removeClass("active");$(this).addClass("active");var n=$(this).attr("tool");console.warn(n);whiteboard.setTool(n);n=="mouse"||n=="recSelect"?$(".activeToolIcon").empty():$(".activeToolIcon").html($(this).html())});$("#addImgToCanvasBtn").click(function(){showBasicAlert("Please drag the image into the browser.")});$("#saveAsImageBtn").click(function(){var t=whiteboard.getImageDataBase64(),n=window.open("about:blank");setTimeout(function(){var i=document.createElement("a");i.href=t;i.download="whiteboard.png";n.document.body.appendChild(i);i.click();n.document.body.removeChild(i);setTimeout(function(){n.close()},100)},0)});$("#saveAsJSONBtn").click(function(){var t=whiteboard.getImageDataJson(),n=window.open("about:blank");setTimeout(function(){var i=document.createElement("a");i.href=window.URL.createObjectURL(new Blob([t],{type:"text/json"}));i.download="whiteboard.json";n.document.body.appendChild(i);i.click();n.document.body.removeChild(i);setTimeout(function(){n.close()},100)},0)});$("#uploadWebDavBtn").click(function(){if(!($(".webdavUploadBtn").length>0)){var t=localStorage.getItem("webdavserver")||"",i=localStorage.getItem("webdavpath")||"/",r=localStorage.getItem("webdavusername")||"",u=localStorage.getItem("webdavpassword")||"",n=$('<div><table><tr><td>Server URL:<\/td><td><input class="webdavserver" type="text" value="'+t+'" placeholder="https://yourserver.com/remote.php/webdav/"><\/td><td><\/td><\/tr><tr><td>Path:<\/td><td><input class="webdavpath" type="text" placeholder="folder" value="'+i+'"><\/td><td style="font-size: 0.7em;"><i>path always have to start & end with "/"<\/i><\/td><\/tr><tr><td>Username:<\/td><td><input class="webdavusername" type="text" value="'+r+'" placeholder="username"><\/td><td style="font-size: 0.7em;"><\/td><\/tr><tr><td>Password:<\/td><td><input class="webdavpassword" type="password" value="'+u+'" placeholder="password"><\/td><td style="font-size: 0.7em;"><\/td><\/tr><tr><td style="font-size: 0.7em;" colspan="3">Note: You have to generate and use app credentials if you have 2 Factor Auth activated on your dav/nextcloud server!<\/td><\/tr><tr><td><\/td><td colspan="2"><span class="loadingWebdavText" style="display:none;">Saving to webdav, please wait...<\/span><button class="modalBtn webdavUploadBtn"><i class="fas fa-upload"><\/i> Start Upload<\/button><\/td><\/tr><\/table><\/div>');n.find(".webdavUploadBtn").click(function(){var u=n.find(".webdavserver").val(),t,i,r,f,e;localStorage.setItem("webdavserver",u);t=n.find(".webdavpath").val();localStorage.setItem("webdavpath",t);i=n.find(".webdavusername").val();localStorage.setItem("webdavusername",i);r=n.find(".webdavpassword").val();localStorage.setItem("webdavpassword",r);f=whiteboard.getImageDataBase64();e={webdavserver:u,webdavpath:t,webdavusername:i,webdavpassword:r};n.find(".loadingWebdavText").show();n.find(".webdavUploadBtn").hide();saveWhiteboardToWebdav(f,e,function(t){t?(n.find(".loadingWebdavText").hide(),n.find(".webdavUploadBtn").show()):n.parents(".basicalert").remove()})});showBasicAlert(n,{header:"Save to Webdav",okBtnText:"cancel",headercolor:"#0082c9"})}});$("#uploadJsonBtn").click(function(){$("#myFile").click()});$("#shareWhiteboardBtn").click(function(){var i=window.location.href,u=i.indexOf("&username=")!==-1?"&username=":"username=",t=i.split(u),r=t[0],n;t.length>1&&(n=t[1].split("&"),n=n.splice(1,1),r+="&"+n.join("&"));$("<textarea/>").appendTo("body").val(r).select().each(function(){document.execCommand("copy")}).remove();showBasicAlert("Copied Whiteboard-URL to clipboard.")});t=!1;$("#minMaxBtn").click(function(){t?($("#toolbar").find(".btn-group").show(),$(this).find("#minBtn").show(),$(this).find("#maxBtn").hide()):($("#toolbar").find(".btn-group:not(.minGroup)").hide(),$(this).find("#minBtn").hide(),$(this).find("#maxBtn").show());t=!t});$("#myFile").on("change",function(){var t=document.getElementById("myFile").files[0],n=new FileReader;n.onload=function(n){try{var t=JSON.parse(n.target.result);whiteboard.loadJsonData(t)}catch(n){showBasicAlert("File was not a valid JSON!")}};n.readAsText(t);$(this).val("")});$("#whiteboardThicknessSlider").on("input",function(){whiteboard.setStrokeThickness($(this).val())});n=0;$("#whiteboardContainer").on("dragenter",function(t){t.preventDefault();t.stopPropagation();n++;whiteboard.dropIndicator.show()});$("#whiteboardContainer").on("dragleave",function(t){t.preventDefault();t.stopPropagation();n--;n===0&&whiteboard.dropIndicator.hide()});$("#whiteboardContainer").on("drop",function(t){var u,f,r;if(t.originalEvent.dataTransfer)if(t.originalEvent.dataTransfer.files.length)t.preventDefault(),t.stopPropagation(),u=t.originalEvent.dataTransfer.files[0].name,isImageFileName(u)?(f=t.originalEvent.dataTransfer.files[0],r=new window.FileReader,r.readAsDataURL(f),r.onloadend=function(){base64data=r.result;uploadImgAndAddToWhiteboard(base64data)}):showBasicAlert("File must be an image!");else{var e=t.originalEvent.dataTransfer.getData("URL"),o=t.originalEvent.dataTransfer.getData("text/html"),i=/src="?([^"\s]+)"?\s*/.exec(o);i=i&&i.length>1?i[1]:"";isValidImageUrl(e,function(n){n&&isImageFileName(i)?whiteboard.addImgToCanvasByUrl(e):isValidImageUrl(i,function(n){n?isImageFileName(i)||i.startsWith("http")?whiteboard.addImgToCanvasByUrl(i):uploadImgAndAddToWhiteboard(i):showBasicAlert("Can only upload Imagedata!")})})}n=0;whiteboard.dropIndicator.hide()});$("#whiteboardColorpicker").colorPicker({renderCallback:function(n){whiteboard.setDrawColor(n.val())}})});window.addEventListener("dragover",function(n){n=n||event;n.preventDefault()},!1);window.addEventListener("drop",function(n){n=n||event;n.preventDefault()},!1);window.addEventListener("paste",function(n){var t,u,i,f,r;if(!($(".basicalert").length>0)&&n.clipboardData){if(t=n.clipboardData.items,u=!1,t)for(i=0;i<t.length;i++)t[i].type.indexOf("image")!==-1&&(u=!0,f=t[i].getAsFile(),r=new window.FileReader,r.readAsDataURL(f),r.onloadend=function(){console.log("Uploading image!");base64data=r.result;uploadImgAndAddToWhiteboard(base64data)});u||whiteboard.tool=="text"||showBasicAlert("Please Drag&Drop the image into the Whiteboard. (Browsers don't allow copy+past from the filesystem directly)")}});