function Janus(n){function st(n){var t={high:9e5,medium:3e5,low:1e5};return n!==undefined&&n!==null&&(n.high&&(t.high=n.high),n.medium&&(t.medium=n.medium),n.low&&(t.low=n.low)),t}function ct(){if(t!=null){if(Janus.debug("Long poll..."),!e){Janus.warn("Is the server down? (connected=false)");return}var i=r+"/"+t+"?rid="+(new Date).getTime();k&&(i=i+"&maxev="+k);h&&(i=i+"&token="+encodeURIComponent(h));f&&(i=i+"&apisecret="+encodeURIComponent(f));Janus.httpAPICall(i,{verb:"GET",withCredentials:a,success:lt,timeout:tt,error:function(t,i){if(Janus.error(t+":",i),ht++,ht>3){e=!1;n.error("Lost connection to the server (is it down?)");return}ct()}})}}function lt(n,r){var v,a,l,s,h,e,y,w,f,p,b;if(ht=0,o||t===undefined||t===null||r===!0||ct(),!o&&Janus.isArray(n)){for(v=0;v<n.length;v++)lt(n[v],!0);return}if(n.janus==="keepalive"){Janus.vdebug("Got a keepalive on session "+t);return}if(n.janus==="server_info"){Janus.debug("Got info on the Janus instance");Janus.debug(n);s=n.transaction;s&&(h=c[s],h&&h(n),delete c[s]);return}if(n.janus==="ack"){Janus.debug("Got an ack on session "+t);Janus.debug(n);s=n.transaction;s&&(h=c[s],h&&h(n),delete c[s]);return}if(n.janus==="success"){Janus.debug("Got a success on session "+t);Janus.debug(n);s=n.transaction;s&&(h=c[s],h&&h(n),delete c[s]);return}if(n.janus==="trickle"){if(e=n.sender,!e){Janus.warn("Missing sender...");return}if(f=i[e],!f){Janus.debug("This handle is not attached to this session");return}a=n.candidate;Janus.debug("Got a trickled candidate on session "+t);Janus.debug(a);l=f.webrtcStuff;l.pc&&l.remoteSdp?(Janus.debug("Adding remote candidate:",a),a&&a.completed!==!0?l.pc.addIceCandidate(a):l.pc.addIceCandidate(Janus.endOfCandidates)):(Janus.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),l.candidates||(l.candidates=[]),l.candidates.push(a),Janus.debug(l.candidates))}else{if(n.janus==="webrtcup"){if(Janus.debug("Got a webrtcup event on session "+t),Janus.debug(n),e=n.sender,!e){Janus.warn("Missing sender...");return}if(f=i[e],!f){Janus.debug("This handle is not attached to this session");return}f.webrtcState(!0);return}if(n.janus==="hangup"){if(Janus.debug("Got a hangup event on session "+t),Janus.debug(n),e=n.sender,!e){Janus.warn("Missing sender...");return}if(f=i[e],!f){Janus.debug("This handle is not attached to this session");return}f.webrtcState(!1,n.reason);f.hangup()}else if(n.janus==="detached"){if(Janus.debug("Got a detached event on session "+t),Janus.debug(n),e=n.sender,!e){Janus.warn("Missing sender...");return}if(f=i[e],!f)return;f.detached=!0;f.ondetached();f.detach()}else if(n.janus==="media"){if(Janus.debug("Got a media event on session "+t),Janus.debug(n),e=n.sender,!e){Janus.warn("Missing sender...");return}if(f=i[e],!f){Janus.debug("This handle is not attached to this session");return}f.mediaState(n.type,n.receiving)}else if(n.janus==="slowlink"){if(Janus.debug("Got a slowlink event on session "+t),Janus.debug(n),e=n.sender,!e){Janus.warn("Missing sender...");return}if(f=i[e],!f){Janus.debug("This handle is not attached to this session");return}f.slowLink(n.uplink,n.lost)}else{if(n.janus==="error"){Janus.error("Ooops: "+n.error.code+" "+n.error.reason);Janus.debug(n);s=n.transaction;s&&(h=c[s],h&&h(n),delete c[s]);return}if(n.janus==="event"){if(Janus.debug("Got a plugin event on session "+t),Janus.debug(n),e=n.sender,!e){Janus.warn("Missing sender...");return}if(y=n.plugindata,!y){Janus.warn("Missing plugindata...");return}if(Janus.debug("  -- Event is coming from "+e+" ("+y.plugin+")"),w=y.data,Janus.debug(w),f=i[e],!f){Janus.warn("This handle is not attached to this session");return}p=n.jsep;p&&(Janus.debug("Handling SDP as well..."),Janus.debug(p));b=f.onmessage;b?(Janus.debug("Notifying application..."),b(w,p)):Janus.debug("No provided notification callback")}else{if(n.janus==="timeout"){Janus.error("Timeout on session "+t);Janus.debug(n);o&&u.close(3504,"Gateway timeout");return}Janus.warn("Unknown message/event  '"+n.janus+"' on session "+t);Janus.debug(n)}}}}function pt(){if(r&&o&&e){w=setTimeout(pt,d);var n={janus:"keepalive",session_id:t,transaction:Janus.randomString(12)};h&&(n.token=h);f&&(n.apisecret=f);u.send(JSON.stringify(n))}}function ft(i){var y=Janus.randomString(12),s={janus:"create",transaction:y},l;if(i.reconnect&&(e=!1,s.janus="claim",s.session_id=t,u&&(u.onopen=null,u.onerror=null,u.onclose=null,w&&(clearTimeout(w),w=null))),h&&(s.token=h),f&&(s.apisecret=f),!r&&Janus.isArray(v)&&(r=v[b],r.indexOf("ws")===0?(o=!0,Janus.log("Server #"+(b+1)+": trying WebSockets to contact Janus ("+r+")")):(o=!1,Janus.log("Server #"+(b+1)+": trying REST API to contact Janus ("+r+")"))),o){u=Janus.newWebSocket(r,"janus-protocol");nt={error:function(){if(Janus.error("Error connecting to the Janus WebSockets server... "+r),Janus.isArray(v)&&!i.reconnect){if(b++,b===v.length){i.error("Error connecting to any of the provided Janus servers: Is the server down?");return}r=null;setTimeout(function(){ft(i)},200);return}i.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){c[y]=function(n){if(Janus.debug(n),n.janus!=="success"){Janus.error("Ooops: "+n.error.code+" "+n.error.reason);i.error(n.error.reason);return}w=setTimeout(pt,d);e=!0;t=n.session_id?n.session_id:n.data.id;i.reconnect?Janus.log("Claimed session: "+t):Janus.log("Created session: "+t);Janus.sessions[t]=ut;i.success()};u.send(JSON.stringify(s))},message:function(n){lt(JSON.parse(n.data))},close:function(){r&&e&&(e=!1,n.error("Lost connection to the server (is it down?)"))}};for(l in nt)u.addEventListener(l,nt[l]);return}Janus.httpAPICall(r,{verb:"POST",withCredentials:a,body:s,success:function(n){if(Janus.debug(n),n.janus!=="success"){Janus.error("Ooops: "+n.error.code+" "+n.error.reason);i.error(n.error.reason);return}e=!0;t=n.session_id?n.session_id:n.data.id;i.reconnect?Janus.log("Claimed session: "+t):Janus.log("Created session: "+t);Janus.sessions[t]=ut;ct();i.success()},error:function(n,t){if(Janus.error(n+":",t),Janus.isArray(v)&&!i.reconnect){if(b++,b===v.length){i.error("Error connecting to any of the provided Janus servers: Is the server down?");return}r=null;setTimeout(function(){ft(i)},200);return}t===""?i.error(n+": Is the server down?"):i.error(n+": "+t)}})}function ei(n){if(n=n||{},n.success=typeof n.success=="function"?n.success:Janus.noop,n.error=typeof n.error=="function"?n.error:Janus.noop,Janus.log("Getting info on Janus instance"),!e){Janus.warn("Is the server down? (connected=false)");n.error("Is the server down? (connected=false)");return}var i=Janus.randomString(12),t={janus:"info",transaction:i};if(h&&(t.token=h),f&&(t.apisecret=f),o){c[i]=function(t){Janus.log("Server info:");Janus.debug(t);t.janus!=="server_info"&&Janus.error("Ooops: "+t.error.code+" "+t.error.reason);n.success(t)};u.send(JSON.stringify(t));return}Janus.httpAPICall(r,{verb:"POST",withCredentials:a,body:t,success:function(t){Janus.log("Server info:");Janus.debug(t);t.janus!=="server_info"&&Janus.error("Ooops: "+t.error.code+" "+t.error.reason);n.success(t)},error:function(t,i){Janus.error(t+":",i);i===""?n.error(t+": Is the server down?"):n.error(t+": "+i)}})}function oi(s){var v,l,y,p,c;if(s=s||{},s.success=typeof s.success=="function"?s.success:Janus.noop,s.error=typeof s.error=="function"?s.error:Janus.noop,v=s.unload===!0,l=!0,s.notifyDestroyed!==undefined&&s.notifyDestroyed!==null&&(l=s.notifyDestroyed===!0),y=s.cleanupHandles===!0,Janus.log("Destroying session "+t+" (unload="+v+")"),!t){Janus.warn("No session to destroy");s.success();l&&n.destroyed();return}if(y)for(p in i)vt(p,{noRequest:!0});if(!e){Janus.warn("Is the server down? (connected=false)");t=null;s.success();return}if(c={janus:"destroy",transaction:Janus.randomString(12)},h&&(c.token=h),f&&(c.apisecret=f),v){o?(u.onclose=null,u.close(),u=null):navigator.sendBeacon(r+"/"+t,JSON.stringify(c));Janus.log("Destroyed session:");t=null;e=!1;s.success();l&&n.destroyed();return}if(o){c.session_id=t;var b=function(){for(var n in nt)u.removeEventListener(n,nt[n]);u.removeEventListener("message",k);u.removeEventListener("error",d);w&&clearTimeout(w);u.close()},k=function(t){var i=JSON.parse(t.data);i.session_id==c.session_id&&i.transaction==c.transaction&&(b(),s.success(),l&&n.destroyed())},d=function(){b();s.error("Failed to destroy the server: Is the server down?");l&&n.destroyed()};u.addEventListener("message",k);u.addEventListener("error",d);u.send(JSON.stringify(c));return}Janus.httpAPICall(r+"/"+t,{verb:"POST",withCredentials:a,body:c,success:function(i){Janus.log("Destroyed session:");Janus.debug(i);t=null;e=!1;i.janus!=="success"&&Janus.error("Ooops: "+i.error.code+" "+i.error.reason);s.success();l&&n.destroyed()},error:function(i,r){Janus.error(i+":",r);t=null;e=!1;s.success();l&&n.destroyed()}})}function si(n){var s;if(n=n||{},n.success=typeof n.success=="function"?n.success:Janus.noop,n.error=typeof n.error=="function"?n.error:Janus.noop,n.consentDialog=typeof n.consentDialog=="function"?n.consentDialog:Janus.noop,n.iceState=typeof n.iceState=="function"?n.iceState:Janus.noop,n.mediaState=typeof n.mediaState=="function"?n.mediaState:Janus.noop,n.webrtcState=typeof n.webrtcState=="function"?n.webrtcState:Janus.noop,n.slowLink=typeof n.slowLink=="function"?n.slowLink:Janus.noop,n.onmessage=typeof n.onmessage=="function"?n.onmessage:Janus.noop,n.onlocalstream=typeof n.onlocalstream=="function"?n.onlocalstream:Janus.noop,n.onremotestream=typeof n.onremotestream=="function"?n.onremotestream:Janus.noop,n.ondata=typeof n.ondata=="function"?n.ondata:Janus.noop,n.ondataopen=typeof n.ondataopen=="function"?n.ondataopen:Janus.noop,n.oncleanup=typeof n.oncleanup=="function"?n.oncleanup:Janus.noop,n.ondetached=typeof n.ondetached=="function"?n.ondetached:Janus.noop,!e){Janus.warn("Is the server down? (connected=false)");n.error("Is the server down? (connected=false)");return}if(s=n.plugin,!s){Janus.error("Invalid plugin");n.error("Invalid plugin");return}var w=n.opaqueId,v=n.token?n.token:h,y=Janus.randomString(12),l={janus:"attach",plugin:s,opaque_id:w,transaction:y};if(v&&(l.token=v),f&&(l.apisecret=f),o){c[y]=function(t){var r,u;if(Janus.debug(t),t.janus!=="success"){Janus.error("Ooops: "+t.error.code+" "+t.error.reason);n.error("Ooops: "+t.error.code+" "+t.error.reason);return}r=t.data.id;Janus.log("Created handle: "+r);u={session:ut,plugin:s,id:r,token:v,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return s},getVolume:function(){return g(r,!0)},getRemoteVolume:function(){return g(r,!0)},getLocalVolume:function(){return g(r,!1)},isAudioMuted:function(){return ot(r,!1)},muteAudio:function(){return p(r,!1,!0)},unmuteAudio:function(){return p(r,!1,!1)},isVideoMuted:function(){return ot(r,!0)},muteVideo:function(){return p(r,!0,!0)},unmuteVideo:function(){return p(r,!0,!1)},getBitrate:function(){return ni(r)},send:function(n){wt(r,n)},data:function(n){kt(r,n)},dtmf:function(n){dt(r,n)},consentDialog:n.consentDialog,iceState:n.iceState,mediaState:n.mediaState,webrtcState:n.webrtcState,slowLink:n.slowLink,onmessage:n.onmessage,createOffer:function(n){et(r,!0,n)},createAnswer:function(n){et(r,!1,n)},handleRemoteJsep:function(n){gt(r,n)},onlocalstream:n.onlocalstream,onremotestream:n.onremotestream,ondata:n.ondata,ondataopen:n.ondataopen,oncleanup:n.oncleanup,ondetached:n.ondetached,hangup:function(n){yt(r,n===!0)},detach:function(n){vt(r,n)}};i[r]=u;n.success(u)};l.session_id=t;u.send(JSON.stringify(l));return}Janus.httpAPICall(r+"/"+t,{verb:"POST",withCredentials:a,body:l,success:function(t){var r,u;if(Janus.debug(t),t.janus!=="success"){Janus.error("Ooops: "+t.error.code+" "+t.error.reason);n.error("Ooops: "+t.error.code+" "+t.error.reason);return}r=t.data.id;Janus.log("Created handle: "+r);u={session:ut,plugin:s,id:r,token:v,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return s},getVolume:function(){return g(r,!0)},getRemoteVolume:function(){return g(r,!0)},getLocalVolume:function(){return g(r,!1)},isAudioMuted:function(){return ot(r,!1)},muteAudio:function(){return p(r,!1,!0)},unmuteAudio:function(){return p(r,!1,!1)},isVideoMuted:function(){return ot(r,!0)},muteVideo:function(){return p(r,!0,!0)},unmuteVideo:function(){return p(r,!0,!1)},getBitrate:function(){return ni(r)},send:function(n){wt(r,n)},data:function(n){kt(r,n)},dtmf:function(n){dt(r,n)},consentDialog:n.consentDialog,iceState:n.iceState,mediaState:n.mediaState,webrtcState:n.webrtcState,slowLink:n.slowLink,onmessage:n.onmessage,createOffer:function(n){et(r,!0,n)},createAnswer:function(n){et(r,!1,n)},handleRemoteJsep:function(n){gt(r,n)},onlocalstream:n.onlocalstream,onremotestream:n.onremotestream,ondata:n.ondata,ondataopen:n.ondataopen,oncleanup:n.oncleanup,ondetached:n.ondetached,hangup:function(n){yt(r,n===!0)},detach:function(n){vt(r,n)}};i[r]=u;n.success(u)},error:function(t,i){Janus.error(t+":",i);i===""?n.error(t+": Is the server down?"):n.error(t+": "+i)}})}function wt(n,s){var l;if(s=s||{},s.success=typeof s.success=="function"?s.success:Janus.noop,s.error=typeof s.error=="function"?s.error:Janus.noop,!e){Janus.warn("Is the server down? (connected=false)");s.error("Is the server down? (connected=false)");return}if(l=i[n],!l||!l.webrtcStuff){Janus.warn("Invalid handle");s.error("Invalid handle");return}var p=s.message,v=s.jsep,y=Janus.randomString(12),h={janus:"message",body:p,transaction:y};if(l.token&&(h.token=l.token),f&&(h.apisecret=f),v&&(h.jsep={type:v.type,sdp:v.sdp},v.e2ee&&(h.jsep.e2ee=!0)),Janus.debug("Sending message to plugin (handle="+n+"):"),Janus.debug(h),o){h.session_id=t;h.handle_id=n;c[y]=function(n){var t,i;if(Janus.debug("Message sent!"),Janus.debug(n),n.janus==="success"){if(t=n.plugindata,!t){Janus.warn("Request succeeded, but missing plugindata...");s.success();return}Janus.log("Synchronous transaction successful ("+t.plugin+")");i=t.data;Janus.debug(i);s.success(i);return}if(n.janus!=="ack"){n.error?(Janus.error("Ooops: "+n.error.code+" "+n.error.reason),s.error(n.error.code+" "+n.error.reason)):(Janus.error("Unknown error"),s.error("Unknown error"));return}s.success()};u.send(JSON.stringify(h));return}Janus.httpAPICall(r+"/"+t+"/"+n,{verb:"POST",withCredentials:a,body:h,success:function(n){var t,i;if(Janus.debug("Message sent!"),Janus.debug(n),n.janus==="success"){if(t=n.plugindata,!t){Janus.warn("Request succeeded, but missing plugindata...");s.success();return}Janus.log("Synchronous transaction successful ("+t.plugin+")");i=t.data;Janus.debug(i);s.success(i);return}if(n.janus!=="ack"){n.error?(Janus.error("Ooops: "+n.error.code+" "+n.error.reason),s.error(n.error.code+" "+n.error.reason)):(Janus.error("Unknown error"),s.error("Unknown error"));return}s.success()},error:function(n,t){Janus.error(n+":",t);s.error(n+": "+t)}})}function bt(n,s){var c,h;if(!e){Janus.warn("Is the server down? (connected=false)");return}if(c=i[n],!c||!c.webrtcStuff){Janus.warn("Invalid handle");return}if(h={janus:"trickle",candidate:s,transaction:Janus.randomString(12)},c.token&&(h.token=c.token),f&&(h.apisecret=f),Janus.vdebug("Sending trickle candidate (handle="+n+"):"),Janus.vdebug(h),o){h.session_id=t;h.handle_id=n;u.send(JSON.stringify(h));return}Janus.httpAPICall(r+"/"+t+"/"+n,{verb:"POST",withCredentials:a,body:h,success:function(n){if(Janus.vdebug("Candidate sent!"),Janus.vdebug(n),n.janus!=="ack"){Janus.error("Ooops: "+n.error.code+" "+n.error.reason);return}},error:function(n,t){Janus.error(n+":",t)}})}function at(n,t,r,u,f){var o=i[n],s;if(!o||!o.webrtcStuff){Janus.warn("Invalid handle");return}var e=o.webrtcStuff,c=function(n){Janus.log("Received message on data channel:",n);var t=n.target.label;o.ondata(n.data,t)},h=function(n){var i;Janus.log("Received state change on data channel:",n);var t=n.target.label,u=n.target.protocol,r=e.dataChannel[t]?e.dataChannel[t].readyState:"null";if(Janus.log("State change on <"+t+"> data channel: "+r),r==="open"){if(e.dataChannel[t].pending&&e.dataChannel[t].pending.length>0){Janus.log("Sending pending messages on <"+t+">:"+e.dataChannel[t].pending.length);for(i of e.dataChannel[t].pending)Janus.log("Sending data on data channel <"+t+">"),Janus.debug(i),e.dataChannel[t].send(i);e.dataChannel[t].pending=[]}o.ondataopen(t,u)}},l=function(n){Janus.error("Got error on data channel:",n)};u?e.dataChannel[t]=u:(s={ordered:!0},r&&(s.protocol=r),e.dataChannel[t]=e.pc.createDataChannel(t,s));e.dataChannel[t].onmessage=c;e.dataChannel[t].onopen=h;e.dataChannel[t].onclose=h;e.dataChannel[t].onerror=l;e.dataChannel[t].pending=[];f&&e.dataChannel[t].pending.push(f)}function kt(n,t){var e,f,u,r;if(t=t||{},t.success=typeof t.success=="function"?t.success:Janus.noop,t.error=typeof t.error=="function"?t.error:Janus.noop,e=i[n],!e||!e.webrtcStuff){Janus.warn("Invalid handle");t.error("Invalid handle");return}if(f=e.webrtcStuff,u=t.text||t.data,!u){Janus.warn("Invalid data");t.error("Invalid data");return}if(r=t.label?t.label:Janus.dataChanDefaultLabel,!f.dataChannel[r]){at(n,r,t.protocol,!1,u,t.protocol);t.success();return}if(f.dataChannel[r].readyState!=="open"){f.dataChannel[r].pending.push(u);t.success();return}Janus.log("Sending data on data channel <"+r+">");Janus.debug(u);f.dataChannel[r].send(u);t.success()}function dt(n,t){var f,r,c,o,u,e,s,h;if(t=t||{},t.success=typeof t.success=="function"?t.success:Janus.noop,t.error=typeof t.error=="function"?t.error:Janus.noop,f=i[n],!f||!f.webrtcStuff){Janus.warn("Invalid handle");t.error("Invalid handle");return}if(r=f.webrtcStuff,!r.dtmfSender){if(r.pc){if(c=r.pc.getSenders(),o=c.find(function(n){return n.track&&n.track.kind==="audio"}),!o){Janus.warn("Invalid DTMF configuration (no audio track)");t.error("Invalid DTMF configuration (no audio track)");return}r.dtmfSender=o.dtmf;r.dtmfSender&&(Janus.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(n){Janus.debug("Sent DTMF tone: "+n.tone)})}if(!r.dtmfSender){Janus.warn("Invalid DTMF configuration");t.error("Invalid DTMF configuration");return}}if(u=t.dtmf,!u){Janus.warn("Invalid DTMF parameters");t.error("Invalid DTMF parameters");return}if(e=u.tones,!e){Janus.warn("Invalid DTMF string");t.error("Invalid DTMF string");return}s=typeof u.duration=="number"?u.duration:500;h=typeof u.gap=="number"?u.gap:50;Janus.debug("Sending DTMF string "+e+" (duration "+s+"ms, gap "+h+"ms)");r.dtmfSender.insertDTMF(e,s,h);t.success()}function vt(n,s){var l,c,h;if(s=s||{},s.success=typeof s.success=="function"?s.success:Janus.noop,s.error=typeof s.error=="function"?s.error:Janus.noop,l=s.noRequest===!0,Janus.log("Destroying handle "+n+" (only-locally="+l+")"),yt(n),c=i[n],!c||c.detached){delete i[n];s.success();return}if(l){delete i[n];s.success();return}if(!e){Janus.warn("Is the server down? (connected=false)");s.error("Is the server down? (connected=false)");return}if(h={janus:"detach",transaction:Janus.randomString(12)},c.token&&(h.token=c.token),f&&(h.apisecret=f),o){h.session_id=t;h.handle_id=n;u.send(JSON.stringify(h));delete i[n];s.success();return}Janus.httpAPICall(r+"/"+t+"/"+n,{verb:"POST",withCredentials:a,body:h,success:function(t){Janus.log("Destroyed handle:");Janus.debug(t);t.janus!=="success"&&Janus.error("Ooops: "+t.error.code+" "+t.error.reason);delete i[n];s.success()},error:function(t,r){Janus.error(t+":",r);delete i[n];s.success()}})}function y(n,t,r,u,f){var h=i[n],e,w,v,y,c,o,a,p,b,k;if(!h||!h.webrtcStuff){Janus.warn("Invalid handle");u.stream||Janus.stopAllTracks(f);u.error("Invalid handle");return}if(e=h.webrtcStuff,Janus.debug("streamsDone:",f),f&&(Janus.debug("  -- Audio tracks:",f.getAudioTracks()),Janus.debug("  -- Video tracks:",f.getVideoTracks())),w=!1,e.myStream&&r.update&&!e.streamExternal){if((!r.update&&s(r)||r.update&&(r.addAudio||r.replaceAudio))&&f.getAudioTracks()&&f.getAudioTracks().length)if(e.myStream.addTrack(f.getAudioTracks()[0]),Janus.unifiedPlan){if(Janus.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",f.getAudioTracks()[0]),v=null,c=e.pc.getTransceivers(),c&&c.length>0)for(o of c)if(o.sender&&o.sender.track&&o.sender.track.kind==="audio"||o.receiver&&o.receiver.track&&o.receiver.track.kind==="audio"){v=o;break}v&&v.sender?v.sender.replaceTrack(f.getAudioTracks()[0]):e.pc.addTrack(f.getAudioTracks()[0],f)}else Janus.log((r.replaceAudio?"Replacing":"Adding")+" audio track:",f.getAudioTracks()[0]),e.pc.addTrack(f.getAudioTracks()[0],f);if((!r.update&&l(r)||r.update&&(r.addVideo||r.replaceVideo))&&f.getVideoTracks()&&f.getVideoTracks().length)if(e.myStream.addTrack(f.getVideoTracks()[0]),Janus.unifiedPlan){if(Janus.log((r.replaceVideo?"Replacing":"Adding")+" video track:",f.getVideoTracks()[0]),y=null,c=e.pc.getTransceivers(),c&&c.length>0)for(o of c)if(o.sender&&o.sender.track&&o.sender.track.kind==="video"||o.receiver&&o.receiver.track&&o.receiver.track.kind==="video"){y=o;break}y&&y.sender?y.sender.replaceTrack(f.getVideoTracks()[0]):e.pc.addTrack(f.getVideoTracks()[0],f)}else Janus.log((r.replaceVideo?"Replacing":"Adding")+" video track:",f.getVideoTracks()[0]),e.pc.addTrack(f.getVideoTracks()[0],f)}else e.myStream=f,w=!0;if(!e.pc){if(a={iceServers:ii,iceTransportPolicy:ri,bundlePolicy:ui},Janus.webRTCAdapter.browserDetails.browser==="chrome"&&(a.sdpSemantics=Janus.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan"),p={optional:[{DtlsSrtpKeyAgreement:!0}]},fi&&p.optional.push({googIPv6:!0}),u.rtcConstraints&&typeof u.rtcConstraints=="object"){Janus.debug("Adding custom PeerConnection constraints:",u.rtcConstraints);for(b in u.rtcConstraints)p.optional.push(u.rtcConstraints[b])}Janus.webRTCAdapter.browserDetails.browser==="edge"&&(a.bundlePolicy="max-bundle");RTCRtpSender&&RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams&&(u.senderTransforms||u.receiverTransforms)&&(e.senderTransforms=u.senderTransforms,e.receiverTransforms=u.receiverTransforms,a.forceEncodedAudioInsertableStreams=!0,a.forceEncodedVideoInsertableStreams=!0,a.encodedInsertableStreams=!0);Janus.log("Creating PeerConnection");Janus.debug(p);e.pc=new RTCPeerConnection(a,p);Janus.debug(e.pc);e.pc.getStats&&(e.volume={},e.bitrate.value="0 kbits/sec");Janus.log("Preparing local SDP and gathering candidates (trickle="+e.trickle+")");e.pc.oniceconnectionstatechange=function(){e.pc&&h.iceState(e.pc.iceConnectionState)};e.pc.onicecandidate=function(t){if(!t.candidate||Janus.webRTCAdapter.browserDetails.browser==="edge"&&t.candidate.candidate.indexOf("endOfCandidates")>0)Janus.log("End of candidates."),e.iceDone=!0,e.trickle===!0?bt(n,{completed:!0}):li(n,u);else{var i={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};e.trickle===!0&&bt(n,i)}};e.pc.ontrack=function(n){var i,t;if(Janus.log("Handling Remote Track"),Janus.debug(n),n.streams){e.remoteStream=n.streams[0];h.onremotestream(e.remoteStream);n.track.onended||(e.receiverTransforms&&(i=null,n.track.kind==="audio"&&e.receiverTransforms.audio?i=n.receiver.createEncodedAudioStreams():n.track.kind==="video"&&e.receiverTransforms.video&&(i=n.receiver.createEncodedVideoStreams()),i&&i.readableStream.pipeThrough(e.receiverTransforms[n.track.kind]).pipeTo(i.writableStream)),t=null,Janus.log("Adding onended callback to track:",n.track),n.track.onended=function(n){if(Janus.log("Remote track removed:",n),e.remoteStream){clearTimeout(t);e.remoteStream.removeTrack(n.target);h.onremotestream(e.remoteStream)}},n.track.onmute=function(n){Janus.log("Remote track muted:",n);e.remoteStream&&t==null&&(t=setTimeout(function(){if(Janus.log("Removing remote track"),e.remoteStream){e.remoteStream.removeTrack(n.target);h.onremotestream(e.remoteStream)}t=null},2520))},n.track.onunmute=function(n){if(Janus.log("Remote track flowing again:",n),t!=null)clearTimeout(t),t=null;else try{e.remoteStream.addTrack(n.target);h.onremotestream(e.remoteStream)}catch(i){Janus.error(i)}})}}}if(w&&f&&(Janus.log("Adding local stream"),k=u.simulcast2===!0,f.getTracks().forEach(function(n){var t,i,r;Janus.log("Adding local track:",n);k?n.kind==="audio"?e.pc.addTrack(n,f):(Janus.log("Enabling rid-based simulcasting:",n),r=st(u.simulcastMaxBitrates),e.pc.addTransceiver(n,{direction:"sendrecv",streams:[f],sendEncodings:[{rid:"h",active:!0,maxBitrate:r.high},{rid:"m",active:!0,maxBitrate:r.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:r.low,scaleResolutionDownBy:4}]})):(t=e.pc.addTrack(n,f),t&&e.senderTransforms&&(i=null,t.track.kind==="audio"&&e.senderTransforms.audio?i=t.createEncodedAudioStreams():t.track.kind==="video"&&e.senderTransforms.video&&(i=t.createEncodedVideoStreams()),i&&i.readableStream.pipeThrough(e.senderTransforms[t.track.kind]).pipeTo(i.writableStream)))})),wi(r)&&!e.dataChannel[Janus.dataChanDefaultLabel]&&(Janus.log("Creating default data channel"),at(n,Janus.dataChanDefaultLabel,null,!1),e.pc.ondatachannel=function(t){Janus.log("Data channel created by Janus:",t);at(n,t.channel.label,t.channel.protocol,t.channel)}),e.myStream)h.onlocalstream(e.myStream);t?e.pc.setRemoteDescription(t).then(function(){var f,i;if(Janus.log("Remote description accepted!"),e.remoteSdp=t.sdp,e.candidates&&e.candidates.length>0){for(f=0;f<e.candidates.length;f++)i=e.candidates[f],Janus.debug("Adding remote candidate:",i),i&&i.completed!==!0?e.pc.addIceCandidate(i):e.pc.addIceCandidate(Janus.endOfCandidates);e.candidates=[]}ci(n,r,u)},u.error):hi(n,r,u)}function et(n,t,r){var o,u,e,f,k,tt,p,d,it,w,g,h,nt,b,et,ot,rt,ut,ft;if(r=r||{},r.success=typeof r.success=="function"?r.success:Janus.noop,r.error=typeof r.error=="function"?r.error:ti,o=r.jsep,t&&o){Janus.error("Provided a JSEP to a createOffer");r.error("Provided a JSEP to a createOffer");return}if(!t&&(!o||!o.type||!o.sdp)){Janus.error("A valid JSEP is required for createAnswer");r.error("A valid JSEP is required for createAnswer");return}if(r.media=typeof r.media=="object"&&r.media?r.media:{audio:!0,video:!0},u=r.media,e=i[n],!e||!e.webrtcStuff){Janus.warn("Invalid handle");r.error("Invalid handle");return}if(f=e.webrtcStuff,f.trickle=bi(r.trickle),f.pc){if(Janus.log("Updating existing media session"),u.update=!0,r.stream)r.stream!==f.myStream&&Janus.log("Renegotiation involves a new external stream");else{if(u.addAudio){if(u.keepAudio=!1,u.replaceAudio=!1,u.removeAudio=!1,u.audioSend=!0,f.myStream&&f.myStream.getAudioTracks()&&f.myStream.getAudioTracks().length){Janus.error("Can't add audio stream, there already is one");r.error("Can't add audio stream, there already is one");return}}else u.removeAudio?(u.keepAudio=!1,u.replaceAudio=!1,u.addAudio=!1,u.audioSend=!1):u.replaceAudio&&(u.keepAudio=!1,u.addAudio=!1,u.removeAudio=!1,u.audioSend=!0);if(f.myStream?f.myStream.getAudioTracks()&&f.myStream.getAudioTracks().length!==0?!s(u)||u.removeAudio||u.replaceAudio||(u.keepAudio=!0):(u.replaceAudio&&(u.keepAudio=!1,u.replaceAudio=!1,u.addAudio=!0,u.audioSend=!0),s(u)&&(u.keepAudio=!1,u.addAudio=!0)):(u.replaceAudio&&(u.keepAudio=!1,u.replaceAudio=!1,u.addAudio=!0,u.audioSend=!0),s(u)&&(u.keepAudio=!1,u.addAudio=!0)),u.addVideo){if(u.keepVideo=!1,u.replaceVideo=!1,u.removeVideo=!1,u.videoSend=!0,f.myStream&&f.myStream.getVideoTracks()&&f.myStream.getVideoTracks().length){Janus.error("Can't add video stream, there already is one");r.error("Can't add video stream, there already is one");return}}else u.removeVideo?(u.keepVideo=!1,u.replaceVideo=!1,u.addVideo=!1,u.videoSend=!1):u.replaceVideo&&(u.keepVideo=!1,u.addVideo=!1,u.removeVideo=!1,u.videoSend=!0);f.myStream?f.myStream.getVideoTracks()&&f.myStream.getVideoTracks().length!==0?!l(u)||u.removeVideo||u.replaceVideo||(u.keepVideo=!0):(u.replaceVideo&&(u.keepVideo=!1,u.replaceVideo=!1,u.addVideo=!0,u.videoSend=!0),l(u)&&(u.keepVideo=!1,u.addVideo=!0)):(u.replaceVideo&&(u.keepVideo=!1,u.replaceVideo=!1,u.addVideo=!0,u.videoSend=!0),l(u)&&(u.keepVideo=!1,u.addVideo=!0));u.addData&&(u.data=!0)}if(s(u)&&u.keepAudio&&l(u)&&u.keepVideo){e.consentDialog(!1);y(n,o,u,r,f.myStream);return}}else u.update=!1,u.keepAudio=!1,u.keepVideo=!1;if(u.update&&!f.streamExternal){if(u.removeAudio||u.replaceAudio){if(f.myStream&&f.myStream.getAudioTracks()&&f.myStream.getAudioTracks().length){k=f.myStream.getAudioTracks()[0];Janus.log("Removing audio track:",k);f.myStream.removeTrack(k);try{k.stop()}catch(st){}}if(f.pc.getSenders()&&f.pc.getSenders().length&&(tt=!0,u.replaceAudio&&Janus.unifiedPlan&&(tt=!1),tt))for(p of f.pc.getSenders())p&&p.track&&p.track.kind==="audio"&&(Janus.log("Removing audio sender:",p),f.pc.removeTrack(p))}if(u.removeVideo||u.replaceVideo){if(f.myStream&&f.myStream.getVideoTracks()&&f.myStream.getVideoTracks().length){d=f.myStream.getVideoTracks()[0];Janus.log("Removing video track:",d);f.myStream.removeTrack(d);try{d.stop()}catch(st){}}if(f.pc.getSenders()&&f.pc.getSenders().length&&(it=!0,u.replaceVideo&&Janus.unifiedPlan&&(it=!1),it))for(w of f.pc.getSenders())w&&w.track&&w.track.kind==="video"&&(Janus.log("Removing video sender:",w),f.pc.removeTrack(w))}}if(r.stream){g=r.stream;Janus.log("MediaStream provided by the application");Janus.debug(g);u.update&&f.myStream&&f.myStream!==r.stream&&!f.streamExternal&&(Janus.stopAllTracks(f.myStream),f.myStream=null);f.streamExternal=!0;e.consentDialog(!1);y(n,o,u,r,g);return}if(s(u)||l(u)){if(!Janus.isGetUserMediaAvailable()){r.error("getUserMedia not available");return}if(h={mandatory:{},optional:[]},e.consentDialog(!0),nt=s(u),nt&&u&&typeof u.audio=="object"&&(nt=u.audio),b=l(u),b&&u)if(et=r.simulcast===!0,ot=r.simulcast2===!0,!(et||ot)||o||u.video||(u.video="hires"),u.video&&u.video!="screen"&&u.video!="window")if(typeof u.video=="object")b=u.video;else{var c=0,a=0,v=0;u.video==="lowres"?(a=240,v=240,c=320):u.video==="lowres-16:9"?(a=180,v=180,c=320):u.video==="hires"||u.video==="hires-16:9"||u.video==="hdres"?(a=480,v=480,c=640):u.video==="fhdres"?(a=480,v=480,c=640):u.video==="4kres"?(a=480,v=480,c=640):u.video==="stdres"?(a=480,v=480,c=640):u.video==="stdres-16:9"?(a=360,v=360,c=640):(Janus.log("Default video setting is stdres 4:3"),a=480,v=480,c=640);Janus.log("Adding media constraint:",u.video);b={height:{ideal:100},width:{ideal:100}};Janus.log("Adding video constraint:",b)}else if(u.video==="screen"||u.video==="window"){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){h.video={};u.screenshareFrameRate&&(h.video.frameRate=u.screenshareFrameRate);u.screenshareHeight&&(h.video.height=u.screenshareHeight);u.screenshareWidth&&(h.video.width=u.screenshareWidth);h.audio=u.captureDesktopAudio;navigator.mediaDevices.getDisplayMedia(h).then(function(t){e.consentDialog(!1);s(u)&&!u.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(i){t.addTrack(i.getAudioTracks()[0]);y(n,o,u,r,t)}):y(n,o,u,r,t)},function(n){e.consentDialog(!1);r.error(n)});return}function t(t,i){e.consentDialog(!1);t?r.error(t):y(n,o,u,r,i)}function i(n,t,i){Janus.log("Adding media constraint (screen capture)");Janus.debug(n);navigator.mediaDevices.getUserMedia(n).then(function(n){i?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(i){n.addTrack(i.getAudioTracks()[0]);t(null,n)}):t(null,n)}).catch(function(n){e.consentDialog(!1);t(n)})}if(Janus.webRTCAdapter.browserDetails.browser==="chrome")rt=Janus.webRTCAdapter.browserDetails.version,ut=33,window.navigator.userAgent.match("Linux")&&(ut=35),rt>=26&&rt<=ut?(h={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:u.screenshareFrameRate,maxFrameRate:u.screenshareFrameRate,chromeMediaSource:"screen"}},audio:s(u)&&!u.keepAudio},i(h,t)):Janus.extension.getScreen(function(n,f){if(n)return e.consentDialog(!1),r.error(n);h={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:u.screenshareFrameRate,maxFrameRate:u.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}};h.video.mandatory.chromeMediaSourceId=f;i(h,t,s(u)&&!u.keepAudio)});else if(Janus.webRTCAdapter.browserDetails.browser==="firefox")if(Janus.webRTCAdapter.browserDetails.version>=33)h={video:{mozMediaSource:u.video,mediaSource:u.video},audio:s(u)&&!u.keepAudio},i(h,function(n,i){if(t(n,i),!n)var r=i.currentTime,u=window.setInterval(function(){i||window.clearInterval(u);i.currentTime==r&&(window.clearInterval(u),i.onended&&i.onended());r=i.currentTime},500)});else{ft=new Error("NavigatorUserMediaError");ft.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)";e.consentDialog(!1);r.error(ft);return}return}u&&u.video==="screen"||navigator.mediaDevices.enumerateDevices().then(function(t){var c=t.some(function(n){return n.kind==="audioinput"}),a=pi(u)||t.some(function(n){return n.kind==="videoinput"}),v=s(u),p=l(u),w=vi(u),k=yi(u),f,h,i;if(v||p||w||k)if(f=v?c:!1,h=p?a:!1,f||h){if(!f&&w)return e.consentDialog(!1),r.error("Audio capture is required, but no capture device found"),!1;if(!h&&k)return e.consentDialog(!1),r.error("Video capture is required, but no capture device found"),!1}else return e.consentDialog(!1),r.error("No capture device found"),!1;i={audio:c&&!u.keepAudio?nt:!1,video:a&&!u.keepVideo?b:!1};Janus.debug("getUserMedia constraints",i);i.audio||i.video?navigator.mediaDevices.getUserMedia(i).then(function(t){e.consentDialog(!1);y(n,o,u,r,t)}).catch(function(n){e.consentDialog(!1);r.error({code:n.code,name:n.name,message:n.message})}):(e.consentDialog(!1),y(n,o,u,r,g))}).catch(function(n){e.consentDialog(!1);r.error(n)})}else y(n,o,u,r)}function gt(n,t){var u,f,r;if(t=t||{},t.success=typeof t.success=="function"?t.success:Janus.noop,t.error=typeof t.error=="function"?t.error:ti,u=t.jsep,f=i[n],!f||!f.webrtcStuff){Janus.warn("Invalid handle");t.error("Invalid handle");return}if(r=f.webrtcStuff,u){if(!r.pc){Janus.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep");t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");return}r.pc.setRemoteDescription(u).then(function(){var i,n;if(Janus.log("Remote description accepted!"),r.remoteSdp=u.sdp,r.candidates&&r.candidates.length>0){for(i=0;i<r.candidates.length;i++)n=r.candidates[i],Janus.debug("Adding remote candidate:",n),n&&n.completed!==!0?r.pc.addIceCandidate(n):r.pc.addIceCandidate(Janus.endOfCandidates);r.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}function hi(n,t,r){var b,e,c,h,o,a,v,y,p,tt,nt,k,w,d;if(r=r||{},r.success=typeof r.success=="function"?r.success:Janus.noop,r.error=typeof r.error=="function"?r.error:Janus.noop,r.customizeSdp=typeof r.customizeSdp=="function"?r.customizeSdp:Janus.noop,b=i[n],!b||!b.webrtcStuff){Janus.warn("Invalid handle");r.error("Invalid handle");return}if(e=b.webrtcStuff,c=r.simulcast===!0,c?Janus.log("Creating offer (iceDone="+e.iceDone+", simulcast="+c+")"):Janus.log("Creating offer (iceDone="+e.iceDone+")"),h={},Janus.unifiedPlan){var u=null,f=null,g=e.pc.getTransceivers();if(g&&g.length>0)for(o of g){if(o.sender&&o.sender.track&&o.sender.track.kind==="audio"||o.receiver&&o.receiver.track&&o.receiver.track.kind==="audio"){u||(u=o);continue}if(o.sender&&o.sender.track&&o.sender.track.kind==="video"||o.receiver&&o.receiver.track&&o.receiver.track.kind==="video"){f||(f=o);continue}}a=s(t);v=it(t);a||v?a&&v?u&&(u.setDirection?u.setDirection("sendrecv"):u.direction="sendrecv",Janus.log("Setting audio transceiver to sendrecv:",u)):a&&!v?u&&(u.setDirection?u.setDirection("sendonly"):u.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",u)):!a&&v&&(u?(u.setDirection?u.setDirection("recvonly"):u.direction="recvonly",Janus.log("Setting audio transceiver to recvonly:",u)):(u=e.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",u))):t.removeAudio&&u&&(u.setDirection?u.setDirection("inactive"):u.direction="inactive",Janus.log("Setting audio transceiver to inactive:",u));y=l(t);p=rt(t);y||p?y&&p?f&&(f.setDirection?f.setDirection("sendrecv"):f.direction="sendrecv",Janus.log("Setting video transceiver to sendrecv:",f)):y&&!p?f&&(f.setDirection?f.setDirection("sendonly"):f.direction="sendonly",Janus.log("Setting video transceiver to sendonly:",f)):!y&&p&&(f?(f.setDirection?f.setDirection("recvonly"):f.direction="recvonly",Janus.log("Setting video transceiver to recvonly:",f)):(f=e.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",f))):t.removeVideo&&f&&(f.setDirection?f.setDirection("inactive"):f.direction="inactive",Janus.log("Setting video transceiver to inactive:",f))}else h.offerToReceiveAudio=it(t),h.offerToReceiveVideo=rt(t);tt=r.iceRestart===!0;tt&&(h.iceRestart=!0);Janus.debug(h);nt=l(t);nt&&c&&Janus.webRTCAdapter.browserDetails.browser==="firefox"&&(Janus.log("Enabling Simulcasting for Firefox (RID)"),k=e.pc.getSenders().find(function(n){return n.track.kind==="video"}),k&&(w=k.getParameters(),w||(w={}),d=st(r.simulcastMaxBitrates),w.encodings=[{rid:"h",active:!0,maxBitrate:d.high},{rid:"m",active:!0,maxBitrate:d.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:d.low,scaleResolutionDownBy:4}],k.setParameters(w)));e.pc.createOffer(h).then(function(n){Janus.debug(n);var t={type:n.type,sdp:n.sdp};if(r.customizeSdp(t),n.sdp=t.sdp,Janus.log("Setting local description"),nt&&c&&(Janus.webRTCAdapter.browserDetails.browser==="chrome"||Janus.webRTCAdapter.browserDetails.browser==="safari"?(Janus.log("Enabling Simulcasting for Chrome (SDP munging)"),n.sdp=ai(n.sdp)):Janus.webRTCAdapter.browserDetails.browser!=="firefox"&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),e.mySdp=n.sdp,e.pc.setLocalDescription(n).catch(r.error),e.mediaConstraints=h,!e.iceDone&&!e.trickle){Janus.log("Waiting for all candidates...");return}(e.senderTransforms||e.receiverTransforms)&&(n.e2ee=!0);r.success(n)},r.error)}function ci(n,t,r){var b,e,a,c,o,v,y,p,w,nt,k,tt,d;if(r=r||{},r.success=typeof r.success=="function"?r.success:Janus.noop,r.error=typeof r.error=="function"?r.error:Janus.noop,r.customizeSdp=typeof r.customizeSdp=="function"?r.customizeSdp:Janus.noop,b=i[n],!b||!b.webrtcStuff){Janus.warn("Invalid handle");r.error("Invalid handle");return}if(e=b.webrtcStuff,a=r.simulcast===!0,a?Janus.log("Creating answer (iceDone="+e.iceDone+", simulcast="+a+")"):Janus.log("Creating answer (iceDone="+e.iceDone+")"),c=null,Janus.unifiedPlan){c={};var u=null,f=null,g=e.pc.getTransceivers();if(g&&g.length>0)for(o of g){if(o.sender&&o.sender.track&&o.sender.track.kind==="audio"||o.receiver&&o.receiver.track&&o.receiver.track.kind==="audio"){u||(u=o);continue}if(o.sender&&o.sender.track&&o.sender.track.kind==="video"||o.receiver&&o.receiver.track&&o.receiver.track.kind==="video"){f||(f=o);continue}}if(v=s(t),y=it(t),v||y){if(v&&y){if(u)try{u.setDirection?u.setDirection("sendrecv"):u.direction="sendrecv";Janus.log("Setting audio transceiver to sendrecv:",u)}catch(h){Janus.error(h)}}else if(v&&!y)try{u&&(u.setDirection?u.setDirection("sendonly"):u.direction="sendonly",Janus.log("Setting audio transceiver to sendonly:",u))}catch(h){Janus.error(h)}else if(!v&&y)if(u)try{u.setDirection?u.setDirection("recvonly"):u.direction="recvonly";Janus.log("Setting audio transceiver to recvonly:",u)}catch(h){Janus.error(h)}else u=e.pc.addTransceiver("audio",{direction:"recvonly"}),Janus.log("Adding recvonly audio transceiver:",u)}else if(t.removeAudio&&u)try{u.setDirection?u.setDirection("inactive"):u.direction="inactive";Janus.log("Setting audio transceiver to inactive:",u)}catch(h){Janus.error(h)}if(p=l(t),w=rt(t),p||w){if(p&&w){if(f)try{f.setDirection?f.setDirection("sendrecv"):f.direction="sendrecv";Janus.log("Setting video transceiver to sendrecv:",f)}catch(h){Janus.error(h)}}else if(p&&!w){if(f)try{f.setDirection?f.setDirection("sendonly"):f.direction="sendonly";Janus.log("Setting video transceiver to sendonly:",f)}catch(h){Janus.error(h)}}else if(!p&&w)if(f)try{f.setDirection?f.setDirection("recvonly"):f.direction="recvonly";Janus.log("Setting video transceiver to recvonly:",f)}catch(h){Janus.error(h)}else f=e.pc.addTransceiver("video",{direction:"recvonly"}),Janus.log("Adding recvonly video transceiver:",f)}else if(t.removeVideo&&f)try{f.setDirection?f.setDirection("inactive"):f.direction="inactive";Janus.log("Setting video transceiver to inactive:",f)}catch(h){Janus.error(h)}}else c=Janus.webRTCAdapter.browserDetails.browser==="firefox"||Janus.webRTCAdapter.browserDetails.browser==="edge"?{offerToReceiveAudio:it(t),offerToReceiveVideo:rt(t)}:{mandatory:{OfferToReceiveAudio:it(t),OfferToReceiveVideo:rt(t)}};Janus.debug(c);nt=l(t);nt&&a&&Janus.webRTCAdapter.browserDetails.browser==="firefox"&&(Janus.log("Enabling Simulcasting for Firefox (RID)"),k=e.pc.getSenders()[1],Janus.log(k),tt=k.getParameters(),Janus.log(tt),d=st(r.simulcastMaxBitrates),k.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:d.high},{rid:"medium",active:!0,priority:"medium",maxBitrate:d.medium},{rid:"low",active:!0,priority:"low",maxBitrate:d.low}]}));e.pc.createAnswer(c).then(function(n){Janus.debug(n);var t={type:n.type,sdp:n.sdp};if(r.customizeSdp(t),n.sdp=t.sdp,Janus.log("Setting local description"),nt&&a&&(Janus.webRTCAdapter.browserDetails.browser==="chrome"?Janus.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):Janus.webRTCAdapter.browserDetails.browser!=="firefox"&&Janus.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),e.mySdp=n.sdp,e.pc.setLocalDescription(n).catch(r.error),e.mediaConstraints=c,!e.iceDone&&!e.trickle){Janus.log("Waiting for all candidates...");return}(e.senderTransforms||e.receiverTransforms)&&(n.e2ee=!0);r.success(n)},r.error)}function li(n,t){var u,r;if(t=t||{},t.success=typeof t.success=="function"?t.success:Janus.noop,t.error=typeof t.error=="function"?t.error:Janus.noop,u=i[n],!u||!u.webrtcStuff){Janus.warn("Invalid handle, not sending anything");return}if(r=u.webrtcStuff,Janus.log("Sending offer/answer SDP..."),!r.mySdp){Janus.warn("Local SDP instance is invalid, not sending anything...");return}r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp};r.trickle===!1&&(r.mySdp.trickle=!1);Janus.debug(t);r.sdpSent=!0;t.success(r.mySdp)}function g(n,t){var f=i[n],u,r;return!f||!f.webrtcStuff?(Janus.warn("Invalid handle"),0):(u=t?"remote":"local",r=f.webrtcStuff,r.volume[u]||(r.volume[u]={value:0}),r.pc.getStats&&(Janus.webRTCAdapter.browserDetails.browser==="chrome"||Janus.webRTCAdapter.browserDetails.browser==="safari")?t&&!r.remoteStream?(Janus.warn("Remote stream unavailable"),0):!t&&!r.myStream?(Janus.warn("Local stream unavailable"),0):r.volume[u].timer?r.volume[u].value:(Janus.log("Starting "+u+" volume monitor"),r.volume[u].timer=setInterval(function(){r.pc.getStats().then(function(n){n.forEach(function(n){n&&n.kind==="audio"&&(!t||n.remoteSource)&&(t||n.type==="media-source")&&(r.volume[u].value=n.audioLevel?n.audioLevel:0)})})},200),0):(Janus.warn("Getting the "+u+" volume unsupported by browser"),0))}function ot(n,t){var u=i[n],r;return!u||!u.webrtcStuff?(Janus.warn("Invalid handle"),!0):(r=u.webrtcStuff,!r.pc)?(Janus.warn("Invalid PeerConnection"),!0):r.myStream?t?!r.myStream.getVideoTracks()||r.myStream.getVideoTracks().length===0?(Janus.warn("No video track"),!0):!r.myStream.getVideoTracks()[0].enabled:!r.myStream.getAudioTracks()||r.myStream.getAudioTracks().length===0?(Janus.warn("No audio track"),!0):!r.myStream.getAudioTracks()[0].enabled:(Janus.warn("Invalid local MediaStream"),!0)}function p(n,t,r){var f=i[n],u;return!f||!f.webrtcStuff?(Janus.warn("Invalid handle"),!1):(u=f.webrtcStuff,!u.pc)?(Janus.warn("Invalid PeerConnection"),!1):u.myStream?t?!u.myStream.getVideoTracks()||u.myStream.getVideoTracks().length===0?(Janus.warn("No video track"),!1):(u.myStream.getVideoTracks()[0].enabled=!r,!0):!u.myStream.getAudioTracks()||u.myStream.getAudioTracks().length===0?(Janus.warn("No audio track"),!1):(u.myStream.getAudioTracks()[0].enabled=!r,!0):(Janus.warn("Invalid local MediaStream"),!1)}function ni(n){var r=i[n],t;return!r||!r.webrtcStuff?(Janus.warn("Invalid handle"),"Invalid handle"):(t=r.webrtcStuff,!t.pc)?"Invalid PeerConnection":t.pc.getStats?t.bitrate.timer?t.bitrate.value:(Janus.log("Starting bitrate timer (via getStats)"),t.bitrate.timer=setInterval(function(){t.pc.getStats().then(function(n){n.forEach(function(n){var i,r,u;n&&(i=!1,(n.mediaType==="video"||n.id.toLowerCase().indexOf("video")>-1)&&n.type==="inbound-rtp"&&n.id.indexOf("rtcp")<0?i=!0:n.type=="ssrc"&&n.bytesReceived&&(n.googCodecName==="VP8"||n.googCodecName==="")&&(i=!0),i&&(t.bitrate.bsnow=n.bytesReceived,t.bitrate.tsnow=n.timestamp,t.bitrate.bsbefore===null||t.bitrate.tsbefore===null?(t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow):(r=t.bitrate.tsnow-t.bitrate.tsbefore,Janus.webRTCAdapter.browserDetails.browser==="safari"&&(r=r/1e3),u=Math.round((t.bitrate.bsnow-t.bitrate.bsbefore)*8/r),Janus.webRTCAdapter.browserDetails.browser==="safari"&&(u=parseInt(u/1e3)),t.bitrate.value=u+" kbits/sec",t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow)))})})},1e3),"0 kbits/sec"):(Janus.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function ti(n){Janus.error("WebRTC error:",n)}function yt(n,e){var c,s,h;if(Janus.log("Cleaning WebRTC stuff"),c=i[n],c){if(s=c.webrtcStuff,s){e===!0&&(h={janus:"hangup",transaction:Janus.randomString(12)},c.token&&(h.token=c.token),f&&(h.apisecret=f),Janus.debug("Sending hangup request (handle="+n+"):"),Janus.debug(h),o?(h.session_id=t,h.handle_id=n,u.send(JSON.stringify(h))):Janus.httpAPICall(r+"/"+t+"/"+n,{verb:"POST",withCredentials:a,body:h}));s.remoteStream=null;s.volume&&(s.volume.local&&s.volume.local.timer&&clearInterval(s.volume.local.timer),s.volume.remote&&s.volume.remote.timer&&clearInterval(s.volume.remote.timer));s.volume={};s.bitrate.timer&&clearInterval(s.bitrate.timer);s.bitrate.timer=null;s.bitrate.bsnow=null;s.bitrate.bsbefore=null;s.bitrate.tsnow=null;s.bitrate.tsbefore=null;s.bitrate.value=null;!s.streamExternal&&s.myStream&&(Janus.log("Stopping local stream tracks"),Janus.stopAllTracks(s.myStream));s.streamExternal=!1;s.myStream=null;try{s.pc.close()}catch(l){}s.pc=null;s.candidates=null;s.mySdp=null;s.remoteSdp=null;s.iceDone=!1;s.dataChannel={};s.dtmfSender=null;s.senderTransforms=null;s.receiverTransforms=null}c.oncleanup()}}function ai(n){for(var y,l,v,p,f,i=n.split("\r\n"),a=!1,r=[-1],e=[-1],o=null,s=null,h=null,c=null,u=-1,t=0;t<i.length;t++){if(l=i[t].match(/m=(\w+) */),l){if(v=l[1],v==="video")if(r[0]<0)a=!0;else{u=t;break}else if(r[0]>-1){u=t;break}continue}if(a){if(y=i[t].match(/a=ssrc-group:FID (\d+) (\d+)/),y){r[0]=y[1];e[0]=y[2];i.splice(t,1);t--;continue}if(r[0]){if(f=i[t].match("a=ssrc:"+r[0]+" cname:(.+)"),f&&(o=f[1]),f=i[t].match("a=ssrc:"+r[0]+" msid:(.+)"),f&&(s=f[1]),f=i[t].match("a=ssrc:"+r[0]+" mslabel:(.+)"),f&&(h=f[1]),f=i[t].match("a=ssrc:"+r[0]+" label:(.+)"),f&&(c=f[1]),i[t].indexOf("a=ssrc:"+e[0])===0){i.splice(t,1);t--;continue}if(i[t].indexOf("a=ssrc:"+r[0])===0){i.splice(t,1);t--;continue}}if(i[t].length==0){i.splice(t,1);t--;continue}}}if(r[0]<0)for(u=-1,a=!1,t=0;t<i.length;t++){if(l=i[t].match(/m=(\w+) */),l){if(v=l[1],v==="video")if(r[0]<0)a=!0;else{u=t;break}else if(r[0]>-1){u=t;break}continue}if(a){if(r[0]<0){if(p=i[t].match(/a=ssrc:(\d+)/),p){r[0]=p[1];i.splice(t,1);t--;continue}}else{if(f=i[t].match("a=ssrc:"+r[0]+" cname:(.+)"),f&&(o=f[1]),f=i[t].match("a=ssrc:"+r[0]+" msid:(.+)"),f&&(s=f[1]),f=i[t].match("a=ssrc:"+r[0]+" mslabel:(.+)"),f&&(h=f[1]),f=i[t].match("a=ssrc:"+r[0]+" label:(.+)"),f&&(c=f[1]),i[t].indexOf("a=ssrc:"+e[0])===0){i.splice(t,1);t--;continue}if(i[t].indexOf("a=ssrc:"+r[0])===0){i.splice(t,1);t--;continue}}if(i[t].length===0){i.splice(t,1);t--;continue}}}if(r[0]<0)return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),n;for(u<0&&(u=i.length),r[1]=Math.floor(Math.random()*4294967295),r[2]=Math.floor(Math.random()*4294967295),e[1]=Math.floor(Math.random()*4294967295),e[2]=Math.floor(Math.random()*4294967295),t=0;t<r.length;t++)o&&(i.splice(u,0,"a=ssrc:"+r[t]+" cname:"+o),u++),s&&(i.splice(u,0,"a=ssrc:"+r[t]+" msid:"+s),u++),h&&(i.splice(u,0,"a=ssrc:"+r[t]+" mslabel:"+h),u++),c&&(i.splice(u,0,"a=ssrc:"+r[t]+" label:"+c),u++),o&&(i.splice(u,0,"a=ssrc:"+e[t]+" cname:"+o),u++),s&&(i.splice(u,0,"a=ssrc:"+e[t]+" msid:"+s),u++),h&&(i.splice(u,0,"a=ssrc:"+e[t]+" mslabel:"+h),u++),c&&(i.splice(u,0,"a=ssrc:"+e[t]+" label:"+c),u++);return i.splice(u,0,"a=ssrc-group:FID "+r[2]+" "+e[2]),i.splice(u,0,"a=ssrc-group:FID "+r[1]+" "+e[1]),i.splice(u,0,"a=ssrc-group:FID "+r[0]+" "+e[0]),i.splice(u,0,"a=ssrc-group:SIM "+r[0]+" "+r[1]+" "+r[2]),n=i.join("\r\n"),n.endsWith("\r\n")||(n+="\r\n"),n}function s(n){return(Janus.debug("isAudioSendEnabled:",n),!n)?!0:n.audio===!1?!1:n.audioSend===undefined||n.audioSend===null?!0:n.audioSend===!0}function vi(n){return(Janus.debug("isAudioSendRequired:",n),!n)?!1:n.audio===!1||n.audioSend===!1?!1:n.failIfNoAudio===undefined||n.failIfNoAudio===null?!1:n.failIfNoAudio===!0}function it(n){return(Janus.debug("isAudioRecvEnabled:",n),!n)?!0:n.audio===!1?!1:n.audioRecv===undefined||n.audioRecv===null?!0:n.audioRecv===!0}function l(n){return(Janus.debug("isVideoSendEnabled:",n),!n)?!0:n.video===!1?!1:n.videoSend===undefined||n.videoSend===null?!0:n.videoSend===!0}function yi(n){return(Janus.debug("isVideoSendRequired:",n),!n)?!1:n.video===!1||n.videoSend===!1?!1:n.failIfNoVideo===undefined||n.failIfNoVideo===null?!1:n.failIfNoVideo===!0}function rt(n){return(Janus.debug("isVideoRecvEnabled:",n),!n)?!0:n.video===!1?!1:n.videoRecv===undefined||n.videoRecv===null?!0:n.videoRecv===!0}function pi(n){if((Janus.debug("isScreenSendEnabled:",n),!n)||typeof n.video!="object"||typeof n.video.mandatory!="object")return!1;var t=n.video.mandatory;return t.chromeMediaSource?t.chromeMediaSource==="desktop"||t.chromeMediaSource==="screen":t.mozMediaSource?t.mozMediaSource==="window"||t.mozMediaSource==="screen":t.mediaSource?t.mediaSource==="window"||t.mediaSource==="screen":!1}function wi(n){return(Janus.debug("isDataEnabled:",n),Janus.webRTCAdapter.browserDetails.browser==="edge")?(Janus.warn("Edge doesn't support data channels yet"),!1):n===undefined||n===null?!1:n.data===!0}function bi(n){return Janus.debug("isTrickleEnabled:",n),n===!1?!1:!0}var k,h,f,d,tt;if(n=n||{},n.success=typeof n.success=="function"?n.success:Janus.noop,n.error=typeof n.error=="function"?n.error:Janus.noop,n.destroyed=typeof n.destroyed=="function"?n.destroyed:Janus.noop,!Janus.initDone)return n.error("Library not initialized"),{};if(!Janus.isWebrtcSupported())return n.error("WebRTC not supported by this browser"),{};if(Janus.log("Library initialized: "+Janus.initDone),!n.server)return n.error("Invalid server url"),{};var o=!1,u=null,nt={},w=null,v=null,b=0,r=n.server;Janus.isArray(r)?(Janus.log("Multiple servers provided ("+r.length+"), will use the first that works"),r=null,v=n.server,Janus.debug(v)):r.indexOf("ws")===0?(o=!0,Janus.log("Using WebSockets to contact Janus: "+r)):(o=!1,Janus.log("Using REST API to contact Janus: "+r));var ii=n.iceServers||[{urls:"stun:stun.l.google.com:19302"}],ri=n.iceTransportPolicy,ui=n.bundlePolicy,fi=n.ipv6===!0,a=!1;n.withCredentials!==undefined&&n.withCredentials!==null&&(a=n.withCredentials===!0);k=10;n.max_poll_events!==undefined&&n.max_poll_events!==null&&(k=n.max_poll_events);k<1&&(k=1);h=null;n.token!==undefined&&n.token!==null&&(h=n.token);f=null;n.apisecret!==undefined&&n.apisecret!==null&&(f=n.apisecret);this.destroyOnUnload=!0;n.destroyOnUnload!==undefined&&n.destroyOnUnload!==null&&(this.destroyOnUnload=n.destroyOnUnload===!0);d=25e3;n.keepAlivePeriod!==undefined&&n.keepAlivePeriod!==null&&(d=n.keepAlivePeriod);isNaN(d)&&(d=25e3);tt=6e4;n.longPollTimeout!==undefined&&n.longPollTimeout!==null&&(tt=n.longPollTimeout);isNaN(tt)&&(tt=6e4);var e=!1,t=null,i={},ut=this,ht=0,c={};ft(n);this.getServer=function(){return r};this.isConnected=function(){return e};this.reconnect=function(n){n=n||{};n.success=typeof n.success=="function"?n.success:Janus.noop;n.error=typeof n.error=="function"?n.error:Janus.noop;n.reconnect=!0;ft(n)};this.getSessionId=function(){return t};this.getInfo=function(n){ei(n)};this.destroy=function(n){oi(n)};this.attach=function(n){si(n)}}Janus.sessions={};Janus.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var n=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return(window.navigator.userAgent.match("Linux")&&(t=35),n>=26&&n<=t)?!0:Janus.extension.isInstalled()}return!0};var defaultExtension={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return document.querySelector("#janus-extension-installed")!==null},getScreen:function(n){var t=window.setTimeout(function(){var t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here<\/a> to install it. (NOTE: this will need you to refresh the page)',n(t)},1e3);this.cache[t]=n;window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var n={};this.cache=n;window.addEventListener("message",function(t){var i,r;t.origin==window.location.origin&&(t.data.type=="janusGotScreen"&&n[t.data.id]?(i=n[t.data.id],delete n[t.data.id],t.data.sourceId===""?(r=new Error("NavigatorUserMediaError"),r.name="You cancelled the request for permission, giving up...",i(r)):i(null,t.data.sourceId)):t.data.type=="janusGetScreenPending"&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id)))})}};Janus.useDefaultDependencies=function(n){var i=n&&n.fetch||fetch,t=n&&n.Promise||Promise,r=n&&n.WebSocket||WebSocket;return{newWebSocket:function(n,t){return new r(n,t)},extension:n&&n.extension||defaultExtension,isArray:function(n){return Array.isArray(n)},webRTCAdapter:n&&n.adapter||adapter,httpAPICall:function(n,r){var f={method:r.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"},u,e;return r.verb==="POST"&&(f.headers["Content-Type"]="application/json"),r.withCredentials!==undefined&&(f.credentials=r.withCredentials===!0?"include":r.withCredentials?r.withCredentials:"omit"),r.body&&(f.body=JSON.stringify(r.body)),u=i(n,f).catch(function(n){return t.reject({message:"Probably a network error, is the server down?",error:n})}),r.timeout&&(e=new t(function(n,t){var i=setTimeout(function(){return clearTimeout(i),t({message:"Request timed out",timeout:r.timeout})},r.timeout)}),u=t.race([u,e])),u.then(function(n){if(n.ok){if(typeof r.success==typeof Janus.noop)return n.json().then(function(n){r.success(n)}).catch(function(i){return t.reject({message:"Failed to parse response body",error:i,response:n})})}else return t.reject({message:"API call failed",response:n})}).catch(function(n){typeof r.error==typeof Janus.noop&&r.error(n.message||"<< internal error >>",n)}),u}}};Janus.useOldDependencies=function(n){var t=n&&n.jQuery||jQuery,i=n&&n.WebSocket||WebSocket;return{newWebSocket:function(n,t){return new i(n,t)},isArray:function(n){return t.isArray(n)},extension:n&&n.extension||defaultExtension,webRTCAdapter:n&&n.adapter||adapter,httpAPICall:function(n,i){var r=i.body!==undefined?{contentType:"application/json",data:JSON.stringify(i.body)}:{},u=i.withCredentials!==undefined?{xhrFields:{withCredentials:i.withCredentials}}:{};return t.ajax(t.extend(r,u,{url:n,type:i.verb,cache:!1,dataType:"json",async:i.async,timeout:i.timeout,success:function(n){typeof i.success==typeof Janus.noop&&i.success(n)},error:function(n,t,r){typeof i.error==typeof Janus.noop&&i.error(t,r)}}))}}};Janus.noop=function(){};Janus.dataChanDefaultLabel="JanusDataChannel";Janus.endOfCandidates=null;Janus.stopAllTracks=function(n){var i,t;try{i=n.getTracks();for(t of i)Janus.log(t),t&&t.stop()}catch(r){}};Janus.init=function(n){var u,t,i,r,e;if(n=n||{},n.callback=typeof n.callback=="function"?n.callback:Janus.noop,Janus.initDone)n.callback();else{if((typeof console=="undefined"||typeof console.log=="undefined")&&(console={log:function(){}}),Janus.trace=Janus.noop,Janus.debug=Janus.noop,Janus.vdebug=Janus.noop,Janus.log=Janus.noop,Janus.warn=Janus.noop,Janus.error=Janus.noop,n.debug!==!0&&n.debug!=="all"||board.isHost){if(Array.isArray(n.debug))for(u of n.debug)switch(u){case"trace":Janus.trace=console.trace.bind(console);break;case"debug":Janus.debug=console.debug.bind(console);break;case"vdebug":Janus.vdebug=console.debug.bind(console);break;case"log":Janus.log=console.log.bind(console);break;case"warn":Janus.warn=console.warn.bind(console);break;case"error":Janus.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+u+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}else Janus.trace=console.trace.bind(console),Janus.debug=console.debug.bind(console),Janus.vdebug=console.debug.bind(console),Janus.log=console.log.bind(console),Janus.warn=console.warn.bind(console),Janus.error=console.error.bind(console);Janus.log("Initializing library");t=n.dependencies||Janus.useDefaultDependencies();Janus.isArray=t.isArray;Janus.webRTCAdapter=t.webRTCAdapter;Janus.httpAPICall=t.httpAPICall;Janus.newWebSocket=t.newWebSocket;Janus.extension=t.extension;Janus.extension.init();Janus.listDevices=function(n,t){n=typeof n=="function"?n:Janus.noop;t==null&&(t={audio:!0,video:!0});Janus.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then(function(t){navigator.mediaDevices.enumerateDevices().then(function(i){Janus.debug(i);n(i);Janus.stopAllTracks(t)})}).catch(function(t){Janus.error(t);n([])}):(Janus.warn("navigator.mediaDevices unavailable"),n([]))};Janus.attachMediaStream=function(n,t){try{n.srcObject=t}catch(i){try{n.src=URL.createObjectURL(t)}catch(i){Janus.error("Error attaching stream to element")}}};Janus.reattachMediaStream=function(n,t){try{n.srcObject=t.srcObject}catch(i){try{n.src=t.src}catch(i){Janus.error("Error reattaching stream to element")}}};var s=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0,o=s?"pagehide":"beforeunload",f=window["on"+o];if(window.addEventListener(o,function(){Janus.log("Closing window");for(var n in Janus.sessions)Janus.sessions[n]&&Janus.sessions[n].destroyOnUnload&&(Janus.log("Destroying session "+n),Janus.sessions[n].destroy({unload:!0,notifyDestroyed:!1}));f&&typeof f=="function"&&f()}),Janus.safariVp8=!1,Janus.webRTCAdapter.browserDetails.browser==="safari"&&Janus.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(i of RTCRtpSender.getCapabilities("video").codecs)if(i&&i.mimeType&&i.mimeType.toLowerCase()==="video/vp8"){Janus.safariVp8=!0;break}Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else r=new RTCPeerConnection({}),r.createOffer({offerToReceiveVideo:!0}).then(function(n){Janus.safariVp8=n.sdp.indexOf("VP8")!==-1;Janus.safariVp8?Janus.log("This version of Safari supports VP8"):Janus.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu");r.close();r=null});if(Janus.unifiedPlan=!1,Janus.webRTCAdapter.browserDetails.browser==="firefox"&&Janus.webRTCAdapter.browserDetails.version>=59)Janus.unifiedPlan=!0;else if(Janus.webRTCAdapter.browserDetails.browser==="chrome"&&Janus.webRTCAdapter.browserDetails.version<72)Janus.unifiedPlan=!1;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){e=new RTCPeerConnection;try{e.addTransceiver("audio");Janus.unifiedPlan=!0}catch(h){}e.close()}else Janus.unifiedPlan=!1;Janus.initDone=!0;n.callback()}};Janus.isWebrtcSupported=function(){return!!window.RTCPeerConnection};Janus.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia};Janus.randomString=function(n){for(var t,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="",u=0;u<n;u++)t=Math.floor(Math.random()*i.length),r+=i.substring(t,t+1);return r};