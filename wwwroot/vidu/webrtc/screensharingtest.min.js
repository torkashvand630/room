function randomString(n,t){var i,r,u;for(t=t||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i="",r=0;r<n;r++)u=Math.floor(Math.random()*t.length),i+=t.substring(u,u+1);return i}function initDesctop(){Janus.init({debug:"all",callback:function(){if(!Janus.isWebrtcSupported()){console.log("No WebRTC support... ");return}janusScreen=new Janus({server:server,success:function(){janusScreen.attach({plugin:"janus.plugin.videoroom",opaqueId:opaqueId,success:function(n){screentest=n;Janus.log("Plugin attached! ("+screentest.getPlugin()+", id="+screentest.getId()+")");regerterForScreen()},error:function(n){Janus.error("  -- Error attaching plugin...",n);console.log("Error attaching plugin... "+n)},consentDialog:function(n){Janus.debug("Consent dialog should be "+(n?"on":"off")+" now");n},iceState:function(n){Janus.log("ICE state changed to "+n)},mediaState:function(n,t){Janus.log("Janus "+(t?"started":"stopped")+" receiving our "+n);!t&&screenShareStatus&&(console.log("screen share stop by me ..................."),unpublishOwnFeedScreen())},webrtcState:function(n){Janus.log("Janus says our WebRTC PeerConnection is "+(n?"up":"down")+" now");n},onmessage:function(n,t){var e,i,r,u,f,o;if(Janus.debug(" ::: Got a message (publisher) :::",n),e=n.videoroom,Janus.debug("Event: "+e),e)if(e==="joined"){if(myid=n.id,$("#title").html(n.description),Janus.log("Successfully joined room "+n.room+" with ID "+myid),role==="publisher")Janus.debug("Negotiating WebRTC stream for our screen (capture "+capture+")");else if(n.publishers){i=n.publishers;Janus.debug("Got a list of available publishers/feeds:",i);for(r in i)u=i[r].id,f=i[r].display,Janus.debug("  >> ["+u+"] "+f),newRemoteFeed(u,f)}}else if(e==="event")if(role==="listener"&&n.publishers){i=n.publishers;Janus.debug("Got a list of available publishers/feeds:",i);for(r in i)u=i[r].id,f=i[r].display,Janus.debug("  >> ["+u+"] "+f),newRemoteFeed(u,f)}else n.leaving?(o=n.leaving,Janus.log("Publisher left: "+o),role==="listener"&&n.leaving===source&&console.log("The screen sharing session is over, the publisher left",function(){})):n.error&&console.log(n.error);t&&(Janus.debug("Handling SDP as well...",t),screentest.handleRemoteJsep({jsep:t}))},onlocalstream:function(n){Janus.debug(" ::: Got a local stream :::",n);$("#screenvideo").length===0&&$("#screenShareElemnt").append('<video class="rounded centered" id="screenvideo" width="100%" height="100%" autoplay playsinline muted="muted"/>');Janus.attachMediaStream($("#screenvideo").get(0),n);screentest.webrtcStuff.pc.iceConnectionState!=="completed"&&screentest.webrtcStuff.pc.iceConnectionState!=="connected"&&(screenShareStatus=1,connectToScreenShare())},onremotestream:function(){},oncleanup:function(){Janus.log(" ::: Got a cleanup notification :::");$("#screenShareElemnt").empty();screenShareStatus=0;disconnectFromScreenShare()}})},error:function(n){Janus.error(n);console.log(n,function(){})},destroyed:function(){}});desktopClient=janusScreen}})}function unpublishOwnFeedScreen(){if(board.user.permission.screen)screentest.send({message:{request:"unpublish"}})}function publishScreen(){preShareScreen();screentest.createOffer({media:{video:capture,audioSend:!1,videoRecv:!1},success:function(n){Janus.debug("Got publisher SDP!",n);screentest.send({message:{request:"configure",audio:!1,video:!0},jsep:n})},error:function(n){Janus.error("WebRTC error:",n);console.log("WebRTC error... "+n.message)}})}function checkEnterShare(n,t){var i=t.keyCode?t.keyCode:t.which?t.which:t.charCode;return i==13?(preShareScreen(),!1):!0}function preShareScreen(){if(!Janus.isExtensionEnabled()){console.log("You're using Chrome but don't have the screensharing extension installed: click <b><a href='https://chrome.google.com/webstore/detail/janus-webrtc-screensharin/hapfgfdkleiggjjpfpenajgdnfckjpaj' target='_blank'>here<\/a><\/b> to do so",function(){});return}capture="screen";navigator.mozGetUserMedia?bootbox.dialog({title:"Share whole screen or a window?",message:"Firefox handles screensharing in a different way: are you going to share the whole screen, or would you rather pick a single window/application to share instead?",buttons:{screen:{label:"Share screen",className:"btn-primary",callback:function(){capture="screen";shareScreen()}},window:{label:"Pick a window",className:"btn-success",callback:function(){capture="window";shareScreen()}}},onEscape:function(){}}):shareScreen()}function regerterForScreen(){var n={request:"join",room:myroom,ptype:"publisher",display:"screen_"+board.userName};screentest.send({message:n})}function shareScreen(){role="publisher";return}function checkEnterJoin(n,t){var i=t.keyCode?t.keyCode:t.which?t.which:t.charCode;return i==13?(joinScreen(),!1):!0}function joinScreen(){var n;room=parseInt(12345);role="listener";myusername=randomString(12);n={request:"join",room:room,ptype:"publisher",display:myusername};screentest.send({message:n})}var janusScreen=null,screentest=null,opaqueId="screensharingtest-"+randomString(12),room=null,source=null,spinner=null,desktopClient=null;$(document).ready(function(){});